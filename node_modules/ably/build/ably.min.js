/*@license Copyright 2015-2022 Ably Real-time Ltd (ably.com)

Ably JavaScript Library v2.0.2
https://github.com/ably/ably-js

Released under the Apache Licence v2.0*/(function (g, f) {
    if ("object" == typeof exports && "object" == typeof module) {
      module.exports = f();
    } else if ("function" == typeof define && define.amd) {
      define([], f);
    } else if ("object" == typeof exports) {
      exports["Ably"] = f();
    } else {
      g["Ably"] = f();
    }
  }(this, () => {
var exports = {};
var module = { exports };
"use strict";var nt=Object.defineProperty,gr=Object.defineProperties,yr=Object.getOwnPropertyDescriptor,Rr=Object.getOwnPropertyDescriptors,br=Object.getOwnPropertyNames,tt=Object.getOwnPropertySymbols;var Et=Object.prototype.hasOwnProperty,ns=Object.prototype.propertyIsEnumerable;var ts=(s,t,e)=>t in s?nt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,x=(s,t)=>{for(var e in t||(t={}))Et.call(t,e)&&ts(s,e,t[e]);if(tt)for(var e of tt(t))ns.call(t,e)&&ts(s,e,t[e]);return s},J=(s,t)=>gr(s,Rr(t));var ss=(s,t)=>{var e={};for(var n in s)Et.call(s,n)&&t.indexOf(n)<0&&(e[n]=s[n]);if(s!=null&&tt)for(var n of tt(s))t.indexOf(n)<0&&ns.call(s,n)&&(e[n]=s[n]);return e};var rs=(s,t)=>{for(var e in t)nt(s,e,{get:t[e],enumerable:!0})},Pr=(s,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of br(t))!Et.call(s,r)&&r!==e&&nt(s,r,{get:()=>t[r],enumerable:!(n=yr(t,r))||n.enumerable});return s};var Cr=s=>Pr(nt({},"__esModule",{value:!0}),s);var Yi={};rs(Yi,{Realtime:()=>Se,Rest:()=>Oe,default:()=>$i,msgpack:()=>St,protocolMessageFromDeserialized:()=>Gs});module.exports=Cr(Yi);var d=class{};var vt=typeof global!="undefined"?global:typeof window!="undefined"?window:self;function st(s,t){return`${s}`.padStart(t?3:2,"0")}function Tr(s){return d.Config.logTimestamps?function(t){let e=new Date;s(st(e.getHours())+":"+st(e.getMinutes())+":"+st(e.getSeconds())+"."+st(e.getMilliseconds(),1)+" "+t)}:s}var Ir=()=>{var e;let s,t;return typeof((e=vt==null?void 0:vt.console)==null?void 0:e.log)=="function"?(s=function(...n){console.log.apply(console,n)},t=console.warn?function(...n){console.warn.apply(console,n)}:s):s=t=function(){},[s,t].map(Tr)},M=class M{constructor(){M.logLevel=M.LOG_DEFAULT}static initLogHandlers(){let[t,e]=Ir();this.logHandler=t,this.logErrorHandler=e}static logActionNoStrip(t,e,n){M.shouldLog(t)&&(t===1?M.logErrorHandler:M.logHandler)("Ably: "+e+": "+n)}static renamedClientOption(t,e){M.deprecationWarning(`The \`${t}\` client option has been renamed to \`${e}\`. Please update your code to use \`${e}\` instead. \`${t}\` will be removed in a future version.`)}static renamedMethod(t,e,n){M.deprecationWarning(`\`${t}\`\u2019s \`${e}\` method has been renamed to \`${n}\`. Please update your code to use \`${n}\` instead. \`${e}\` will be removed in a future version.`)}static deprecationWarning(t){M.shouldLog(1)&&M.logErrorHandler(`Ably: Deprecation warning - ${t}`)}};M.logLevel=1,M.LOG_NONE=0,M.LOG_ERROR=1,M.LOG_MAJOR=2,M.LOG_MINOR=3,M.LOG_MICRO=4,M.LOG_DEFAULT=1,M.LOG_DEBUG=4,M.logAction=(t,e,n)=>{M.logActionNoStrip(t,e,n)},M.deprecated=(t,e)=>{M.deprecationWarning(`${t} is deprecated and will be removed in a future version. ${e}`)},M.shouldLog=t=>t<=M.logLevel,M.setLog=(t,e)=>{t!==void 0&&(M.logLevel=t),e!==void 0&&(M.logHandler=M.logErrorHandler=e)};var xt=M,o=xt;var w={};rs(w,{Format:()=>ne,allSame:()=>qt,allToLowerCase:()=>Le,allToUpperCase:()=>Ft,arrChooseN:()=>Dt,arrDeleteValue:()=>ls,arrEquals:()=>Wt,arrIntersect:()=>as,arrIntersectOb:()=>cs,arrPopRandomElement:()=>rt,arrSubtract:()=>Sr,arrWithoutValue:()=>Er,cheapRandStr:()=>_e,containsValue:()=>Mr,copy:()=>ee,createMissingPluginError:()=>ds,dataSizeBytes:()=>Ht,decodeBody:()=>q,encodeBody:()=>G,ensureArray:()=>Ut,forInOwnNonNullProperties:()=>Lt,getBackoffCoefficient:()=>us,getGlobalObject:()=>Ne,getJitterCoefficient:()=>hs,getRetryTime:()=>qe,inherits:()=>Or,inspectBody:()=>Nt,inspectError:()=>A,intersect:()=>Bt,isEmpty:()=>Ar,isErrorInfoOrPartialErrorInfo:()=>Be,isNil:()=>Q,isObject:()=>te,keysArray:()=>ce,matchDerivedChannel:()=>Vt,mixin:()=>P,parseQueryString:()=>pe,prototypicalClone:()=>os,randomString:()=>Gt,shallowClone:()=>wr,shallowEquals:()=>jt,throwMissingPluginError:()=>D,toBase64:()=>Re,toQueryString:()=>ie,valuesArray:()=>_t,whenPromiseSettles:()=>B});function is(s){let t="["+s.constructor.name;return s.message&&(t+=": "+s.message),s.statusCode&&(t+="; statusCode="+s.statusCode),s.code&&(t+="; code="+s.code),s.cause&&(t+="; cause="+A(s.cause)),s.href&&!(s.message&&s.message.indexOf("help.ably.io")>-1)&&(t+="; see "+s.href+" "),t+="]",t}var f=class s extends Error{constructor(e,n,r,i){super(e);typeof Object.setPrototypeOf!="undefined"&&Object.setPrototypeOf(this,s.prototype),this.code=n,this.statusCode=r,this.cause=i}toString(){return is(this)}static fromValues(e){let{message:n,code:r,statusCode:i}=e;if(typeof n!="string"||typeof r!="number"||typeof i!="number")throw new Error("ErrorInfo.fromValues(): invalid values: "+d.Config.inspect(e));let a=Object.assign(new s(n,r,i),e);return a.code&&!a.href&&(a.href="https://help.ably.io/error/"+a.code),a}},S=class s extends Error{constructor(e,n,r,i){super(e);typeof Object.setPrototypeOf!="undefined"&&Object.setPrototypeOf(this,s.prototype),this.code=n,this.statusCode=r,this.cause=i}toString(){return is(this)}};function kr(s){return Math.floor(Math.random()*s.length)}function P(s,...t){for(let e=0;e<t.length;e++){let n=t[e];if(!n)break;for(let r in n)Object.prototype.hasOwnProperty.call(n,r)&&(s[r]=n[r])}return s}function ee(s){return P({},s)}function Ut(s){return Q(s)?[]:Array.isArray(s)?s:[s]}function te(s){return Object.prototype.toString.call(s)=="[object Object]"}function Ar(s){for(let t in s)return!1;return!0}function Q(s){return s==null}function wr(s){let t=new Object;for(let e in s)t[e]=s[e];return t}function os(s,t){class e{}e.prototype=s;let n=new e;return t&&P(n,t),n}var Or=function(s,t){if(d.Config.inherits){d.Config.inherits(s,t);return}s.super_=t,s.prototype=os(t.prototype,{constructor:s})};function Mr(s,t){for(let e in s)if(s[e]==t)return!0;return!1}function Bt(s,t){return Array.isArray(t)?as(s,t):cs(s,t)}function as(s,t){let e=[];for(let n=0;n<s.length;n++){let r=s[n];t.indexOf(r)!=-1&&e.push(r)}return e}function cs(s,t){let e=[];for(let n=0;n<s.length;n++){let r=s[n];r in t&&e.push(r)}return e}function Sr(s,t){let e=[];for(let n=0;n<s.length;n++){let r=s[n];t.indexOf(r)==-1&&e.push(r)}return e}function ls(s,t){let e=s.indexOf(t),n=e!=-1;return n&&s.splice(e,1),n}function Er(s,t){let e=s.slice();return ls(e,t),e}function ce(s,t){let e=[];for(let n in s)t&&!Object.prototype.hasOwnProperty.call(s,n)||e.push(n);return e}function _t(s,t){let e=[];for(let n in s)t&&!Object.prototype.hasOwnProperty.call(s,n)||e.push(s[n]);return e}function Lt(s,t){for(let e in s)Object.prototype.hasOwnProperty.call(s,e)&&s[e]&&t(e)}function qt(s,t){if(s.length===0)return!0;let e=s[0][t];return s.every(function(n){return n[t]===e})}var ne=(e=>(e.msgpack="msgpack",e.json="json",e))(ne||{});function rt(s){return s.splice(kr(s),1)[0]}function ie(s){let t=[];if(s)for(let e in s)t.push(encodeURIComponent(e)+"="+encodeURIComponent(s[e]));return t.length?"?"+t.join("&"):""}function pe(s){let t,e=/([^?&=]+)=?([^&]*)/g,n={};for(;t=e.exec(s);)n[decodeURIComponent(t[1])]=decodeURIComponent(t[2]);return n}function Be(s){return typeof s=="object"&&s!==null&&(s instanceof f||s instanceof S)}function A(s){var t,e;return s instanceof Error||((t=s==null?void 0:s.constructor)==null?void 0:t.name)==="ErrorInfo"||((e=s==null?void 0:s.constructor)==null?void 0:e.name)==="PartialErrorInfo"?s.toString():d.Config.inspect(s)}function Nt(s){return d.BufferUtils.isBuffer(s)?s.toString():typeof s=="string"?s:d.Config.inspect(s)}function Ht(s){if(d.BufferUtils.isBuffer(s))return d.BufferUtils.byteLength(s);if(typeof s=="string")return d.Config.stringByteSize(s);throw new Error("Expected input of Utils.dataSizeBytes to be a buffer or string, but was: "+typeof s)}function _e(){return String(Math.random()).substr(2)}var Gt=async s=>{let t=await d.Config.getRandomArrayBuffer(s);return d.BufferUtils.base64Encode(t)};function Dt(s,t){let e=Math.min(t,s.length),n=s.slice(),r=[];for(let i=0;i<e;i++)r.push(rt(n));return r}function B(s,t){s.then(e=>{t==null||t(null,e)}).catch(e=>{t==null||t(e)})}function q(s,t,e){return e=="msgpack"?(t||D("MsgPack"),t.decode(s)):JSON.parse(String(s))}function G(s,t,e){return e=="msgpack"?(t||D("MsgPack"),t.encode(s,!0)):JSON.stringify(s)}function Le(s){return s.map(function(t){return t&&t.toLowerCase()})}function Ft(s){return s.map(function(t){return t&&t.toUpperCase()})}function us(s){return Math.min((s+2)/3,2)}function hs(){return 1-Math.random()*.2}function qe(s,t){return s*us(t)*hs()}function Ne(){return typeof global!="undefined"?global:typeof window!="undefined"?window:self}function jt(s,t){return Object.keys(s).every(e=>s[e]===t[e])&&Object.keys(t).every(e=>t[e]===s[e])}function Vt(s){let t=/^(\[([^?]*)(?:(.*))\])?(.+)$/,e=s.match(t);if(!e||!e.length||e.length<5)throw new f("regex match failed",400,40010);if(e[2])throw new f(`cannot use a derived option with a ${e[2]} channel`,400,40010);return{qualifierParam:e[3]||"",channelName:e[4]}}function Re(s){let t=d.BufferUtils,e=t.utf8Encode(s);return t.base64Encode(e)}function Wt(s,t){return s.length===t.length&&s.every(function(e,n){return e===t[n]})}function ds(s){return new f(`${s} plugin not provided`,40019,400)}function D(s){throw ds(s)}var zt="2.0.2";var xr="ably-js/"+zt,F={ENVIRONMENT:"",REST_HOST:"rest.ably.io",REALTIME_HOST:"realtime.ably.io",FALLBACK_HOSTS:["A.ably-realtime.com","B.ably-realtime.com","C.ably-realtime.com","D.ably-realtime.com","E.ably-realtime.com"],PORT:80,TLS_PORT:443,TIMEOUTS:{disconnectedRetryTimeout:15e3,suspendedRetryTimeout:3e4,httpRequestTimeout:15e3,channelRetryTimeout:15e3,fallbackRetryTimeout:6e5,connectionStateTtl:12e4,realtimeRequestTimeout:1e4,recvTimeout:9e4,webSocketConnectTimeout:1e4,webSocketSlowTimeout:4e3},httpMaxRetryCount:3,maxMessageSize:65536,version:zt,protocolVersion:3,agent:xr,getHost:fs,getPort:Ur,getHttpScheme:Br,environmentFallbackHosts:ps,getFallbackHosts:ms,getHosts:_r,checkHost:gs,objectifyOptions:Nr,normaliseOptions:Hr,defaultGetHeaders:Gr,defaultPostHeaders:Dr};function fs(s,t,e){return e?t=t==s.restHost&&s.realtimeHost||t||s.realtimeHost:t=t||s.restHost,t}function Ur(s,t){return t||s.tls?s.tlsPort:s.port}function Br(s){return s.tls?"https://":"http://"}function ps(s){return[s+"-a-fallback.ably-realtime.com",s+"-b-fallback.ably-realtime.com",s+"-c-fallback.ably-realtime.com",s+"-d-fallback.ably-realtime.com",s+"-e-fallback.ably-realtime.com"]}function ms(s){let t=s.fallbackHosts,e=typeof s.httpMaxRetryCount!="undefined"?s.httpMaxRetryCount:F.httpMaxRetryCount;return t?Dt(t,e):[]}function _r(s,t){let e=[s.restHost].concat(ms(s));return t?e.map(n=>fs(s,n,!0)):e}function gs(s){if(typeof s!="string")throw new f("host must be a string; was a "+typeof s,4e4,400);if(!s.length)throw new f("host must not be zero-length",4e4,400)}function Lr(s,t,e){return s.realtimeHost?s.realtimeHost:s.restHost?(o.logAction(o.LOG_MINOR,"Defaults.normaliseOptions",'restHost is set to "'+s.restHost+'" but realtimeHost is not set, so setting realtimeHost to "'+s.restHost+'" too. If this is not what you want, please set realtimeHost explicitly.'),s.restHost):t?F.REALTIME_HOST:e+"-"+F.REALTIME_HOST}function qr(s){let t={};for(let e in F.TIMEOUTS)t[e]=s[e]||F.TIMEOUTS[e];return t}function ot(s){let t=F.agent;if(s.agents)for(var e in s.agents)t+=" "+e+"/"+s.agents[e];return t}function Nr(s,t,e,n){if(s===void 0){let i=t?`${e} must be initialized with either a client options object, an Ably API key, or an Ably Token`:`${e} must be initialized with a client options object`;throw o.logAction(o.LOG_ERROR,`${e}()`,i),new Error(i)}let r;if(typeof s=="string")if(s.indexOf(":")==-1){if(!t){let i=`${e} cannot be initialized with just an Ably Token; you must provide a client options object with a \`plugins\` property. (Set this Ably Token as the object\u2019s \`token\` property.)`;throw o.logAction(o.LOG_ERROR,`${e}()`,i),new Error(i)}r={token:s}}else{if(!t){let i=`${e} cannot be initialized with just an Ably API key; you must provide a client options object with a \`plugins\` property. (Set this Ably API key as the object\u2019s \`key\` property.)`;throw o.logAction(o.LOG_ERROR,`${e}()`,i),new Error(i)}r={key:s}}else r=s;return n&&(r=J(x({},r),{plugins:x(x({},n),r.plugins)})),r}function Hr(s,t){typeof s.recover=="function"&&s.closeOnUnload===!0&&(o.logAction(o.LOG_ERROR,"Defaults.normaliseOptions","closeOnUnload was true and a session recovery function was set - these are mutually exclusive, so unsetting the latter"),s.recover=void 0),"closeOnUnload"in s||(s.closeOnUnload=!s.recover),"queueMessages"in s||(s.queueMessages=!0);let e=s.environment&&String(s.environment).toLowerCase()||F.ENVIRONMENT,n=!e||e==="production";!s.fallbackHosts&&!s.restHost&&!s.realtimeHost&&!s.port&&!s.tlsPort&&(s.fallbackHosts=n?F.FALLBACK_HOSTS:ps(e));let r=s.restHost||(n?F.REST_HOST:e+"-"+F.REST_HOST),i=Lr(s,n,e);(s.fallbackHosts||[]).concat(r,i).forEach(gs),s.port=s.port||F.PORT,s.tlsPort=s.tlsPort||F.TLS_PORT,"tls"in s||(s.tls=!0);let a=qr(s);t?"useBinaryProtocol"in s?s.useBinaryProtocol=d.Config.supportsBinary&&s.useBinaryProtocol:s.useBinaryProtocol=d.Config.preferBinary:s.useBinaryProtocol=!1;let c={};s.clientId&&(c["X-Ably-ClientId"]=d.BufferUtils.base64Encode(d.BufferUtils.utf8Encode(s.clientId))),"idempotentRestPublishing"in s||(s.idempotentRestPublishing=!0);let l=null,u=s.connectivityCheckUrl;if(s.connectivityCheckUrl){let[p,h]=s.connectivityCheckUrl.split("?");l=h?pe(h):{},p.indexOf("://")===-1&&(p="https://"+p),u=p}return J(x({},s),{realtimeHost:i,restHost:r,maxMessageSize:s.maxMessageSize||F.maxMessageSize,timeouts:a,connectivityCheckParams:l,connectivityCheckUrl:u,headers:c})}function be(s,t){let e=t||{};if(e.cipher){s||D("Crypto");let n=s.getCipher(e.cipher);e.cipher=n.cipherParams,e.channelCipher=n.cipher}else"cipher"in e&&(e.cipher=void 0,e.channelCipher=null);return e}var ys={json:"application/json",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack"},it={format:"json",protocolVersion:F.protocolVersion};function Gr(s,{format:t=it.format,protocolVersion:e=it.protocolVersion}={}){return{accept:ys[t],"X-Ably-Version":e.toString(),"Ably-Agent":ot(s)}}function Dr(s,{format:t=it.format,protocolVersion:e=it.protocolVersion}={}){let n;return{accept:n=ys[t],"content-type":n,"X-Ably-Version":e.toString(),"Ably-Agent":ot(s)}}var R=F;function Rs(s){return Object.assign(F,s)}var Kt=class s{constructor(t){this.members=t||[]}call(t,e){for(let n of this.members)if(n)try{n(t,e)}catch(r){o.logAction(o.LOG_ERROR,"Multicaster multiple callback handler","Unexpected exception: "+r+"; stack = "+r.stack)}}push(...t){this.members.push(...t)}createPromise(){return new Promise((t,e)=>{this.push((n,r)=>{n?e(n):t(r)})})}resolveAll(t){this.call(null,t)}rejectAll(t){this.call(t)}static create(t){let e=new s(t);return Object.assign((n,r)=>e.call(n,r),{push:n=>e.push(n),createPromise:()=>e.createPromise(),resolveAll:n=>e.resolveAll(n),rejectAll:n=>e.rejectAll(n)})}},Pe=Kt;var bs=(i=>(i.Get="get",i.Delete="delete",i.Post="post",i.Put="put",i.Patch="patch",i))(bs||{}),E=bs;var Ps=(c=>(c[c.Success=200]="Success",c[c.NoContent=204]="NoContent",c[c.BadRequest=400]="BadRequest",c[c.Unauthorized=401]="Unauthorized",c[c.Forbidden=403]="Forbidden",c[c.RequestTimeout=408]="RequestTimeout",c[c.InternalServerError=500]="InternalServerError",c))(Ps||{});function Cs(s){return s>=200&&s<400}var le=Ps;var Jt=Math.pow(2,17);function Fr(){return("000000"+Math.floor(Math.random()*1e16)).slice(-16)}function jr(s){return!!s.connection}function Ts(s){return Be(s)?(s.code||(s.statusCode===403?s.code=40300:(s.code=40170,s.statusCode=401)),s):new f(A(s),s.code||40170,s.statusCode||401)}var Vr=(s,t)=>{let e=d.BufferUtils,n=e.utf8Encode(s),r=e.utf8Encode(t),i=e.hmacSha256(n,r);return e.base64Encode(i)};function Is(s){if(!s)return"";typeof s=="string"&&(s=JSON.parse(s));let t=Object.create(null),e=ce(s,!0);if(!e)return"";e.sort();for(let n=0;n<e.length;n++)t[e[n]]=s[e[n]].sort();return JSON.stringify(t)}function ks(s){if(s.authCallback)o.logAction(o.LOG_MINOR,"Auth()","using token auth with authCallback");else if(s.authUrl)o.logAction(o.LOG_MINOR,"Auth()","using token auth with authUrl");else if(s.key)o.logAction(o.LOG_MINOR,"Auth()","using token auth with client-side signing");else if(s.tokenDetails)o.logAction(o.LOG_MINOR,"Auth()","using token auth with supplied token only");else{let t="authOptions must include valid authentication parameters";throw o.logAction(o.LOG_ERROR,"Auth()",t),new Error(t)}}function Wr(s){return"useTokenAuth"in s&&!s.useTokenAuth}function Xt(s){return s.useTokenAuth||!Wr(s)&&(s.authCallback||s.authUrl||s.token||s.tokenDetails)}function zr(s){return!s.key&&!s.authCallback&&!s.authUrl}var Kr=0;function Jr(){return Kr++}var Qt=class{constructor(t,e){this.authOptions={};if(this.client=t,this.tokenParams=e.defaultTokenParams||{},this.currentTokenRequestId=null,this.waitingForTokenRequest=null,Xt(e))zr(e)&&o.logAction(o.LOG_ERROR,"Auth()","Warning: library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),this._saveTokenOptions(e.defaultTokenParams,e),ks(this.authOptions);else{if(!e.key){let n="No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)";throw o.logAction(o.LOG_ERROR,"Auth()",n),new f(n,40160,401)}o.logAction(o.LOG_MINOR,"Auth()","anonymous, using basic auth"),this._saveBasicOptions(e)}}async authorize(t,e){if(e&&e.key&&this.authOptions.key!==e.key)throw new f("Unable to update auth options with incompatible key",40102,401);try{let n=await this._forceNewToken(t!=null?t:null,e!=null?e:null);return jr(this.client)?new Promise((r,i)=>{this.client.connection.connectionManager.onAuthUpdated(n,(a,c)=>a?i(a):r(c))}):n}catch(n){throw this.client.connection&&n.statusCode===le.Forbidden&&this.client.connection.connectionManager.actOnErrorFromAuthorize(n),n}}async _forceNewToken(t,e){this.tokenDetails=null,this._saveTokenOptions(t,e),ks(this.authOptions);try{return this._ensureValidAuthCredentials(!0)}finally{delete this.tokenParams.timestamp,delete this.authOptions.queryTime}}async requestToken(t,e){let n=e||this.authOptions,r=t||ee(this.tokenParams),i,a=this.client;if(n.authCallback)o.logAction(o.LOG_MINOR,"Auth.requestToken()","using token auth with authCallback"),i=n.authCallback;else if(n.authUrl)o.logAction(o.LOG_MINOR,"Auth.requestToken()","using token auth with authUrl"),i=(l,u)=>{let p=P({accept:"application/json, text/plain"},n.authHeaders),h=n.authMethod&&n.authMethod.toLowerCase()==="post",g,m=n.authUrl.indexOf("?");m>-1&&(g=pe(n.authUrl.slice(m)),n.authUrl=n.authUrl.slice(0,m),h||(n.authParams=P(g,n.authParams)));let y=P({},n.authParams||{},l),b=function(I){var C,K;let k=(C=I.body)!=null?C:null,O=null;if(I.error)o.logAction(o.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received Error: "+A(I.error));else{let H=(K=I.headers["content-type"])!=null?K:null;Array.isArray(H)?O=H.join(", "):O=H,o.logAction(o.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received; content-type: "+O+"; body: "+Nt(k))}if(I.error){u(I.error,null);return}if(I.unpacked){u(null,k);return}if(d.BufferUtils.isBuffer(k)&&(k=k.toString()),!O){u(new f("authUrl response is missing a content-type header",40170,401),null);return}let L=O.indexOf("application/json")>-1,xe=O.indexOf("text/plain")>-1||O.indexOf("application/jwt")>-1;if(!L&&!xe){u(new f("authUrl responded with unacceptable content-type "+O+", should be either text/plain, application/jwt or application/json",40170,401),null);return}if(L){if(k.length>Jt){u(new f("authUrl response exceeded max permitted length",40170,401),null);return}try{k=JSON.parse(k)}catch(H){u(new f("Unexpected error processing authURL response; err = "+H.message,40170,401),null);return}}u(null,k,O)};if(o.logAction(o.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Requesting token from "+n.authUrl+"; Params: "+JSON.stringify(y)+"; method: "+(h?"POST":"GET")),h){let I=p||{};I["content-type"]="application/x-www-form-urlencoded";let k=ie(y).slice(1);B(this.client.http.doUri(E.Post,n.authUrl,I,k,g),(O,L)=>b(O||L))}else B(this.client.http.doUri(E.Get,n.authUrl,p||{},null,y),(I,k)=>b(I||k))};else if(n.key)o.logAction(o.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing"),i=(l,u)=>{B(this.createTokenRequest(l,n),(p,h)=>u(p,h!=null?h:null))};else{let l="Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)";throw o.logAction(o.LOG_ERROR,"Auth()","library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),new f(l,40171,403)}"capability"in r&&(r.capability=Is(r.capability));let c=(l,u)=>{let p=l.keyName,h="/keys/"+p+"/requestToken",g=function(y){return a.baseUri(y)+h},m=R.defaultPostHeaders(this.client.options);n.requestHeaders&&P(m,n.requestHeaders),o.logAction(o.LOG_MICRO,"Auth.requestToken().requestToken","Sending POST to "+h+"; Token params: "+JSON.stringify(l)),B(this.client.http.do(E.Post,g,m,JSON.stringify(l),null),(y,b)=>y?u(y):u(b.error,b.body,b.unpacked))};return new Promise((l,u)=>{let p=!1,h=this.client.options.timeouts.realtimeRequestTimeout,g=setTimeout(function(){p=!0;let m="Token request callback timed out after "+h/1e3+" seconds";o.logAction(o.LOG_ERROR,"Auth.requestToken()",m),u(new f(m,40170,401))},h);i(r,function(m,y,b){if(p)return;if(clearTimeout(g),m){o.logAction(o.LOG_ERROR,"Auth.requestToken()","token request signing call returned error; err = "+A(m)),u(Ts(m));return}if(typeof y=="string"){y.length===0?u(new f("Token string is empty",40170,401)):y.length>Jt?u(new f("Token string exceeded max permitted length (was "+y.length+" bytes)",40170,401)):y==="undefined"||y==="null"?u(new f("Token string was literal null/undefined",40170,401)):y[0]==="{"&&!(b&&b.indexOf("application/jwt")>-1)?u(new f("Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details",40170,401)):l({token:y});return}if(typeof y!="object"||y===null){let k="Expected token request callback to call back with a token string or token request/details object, but got a "+typeof y;o.logAction(o.LOG_ERROR,"Auth.requestToken()",k),u(new f(k,40170,401));return}let I=JSON.stringify(y).length;if(I>Jt&&!n.suppressMaxLengthCheck){u(new f("Token request/details object exceeded max permitted stringified size (was "+I+" bytes)",40170,401));return}if("issued"in y){l(y);return}if(!("keyName"in y)){let k="Expected token request callback to call back with a token string, token request object, or token details object";o.logAction(o.LOG_ERROR,"Auth.requestToken()",k),u(new f(k,40170,401));return}c(y,function(k,O,L){if(k){o.logAction(o.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+A(k)),u(Ts(k));return}L||(O=JSON.parse(O)),o.logAction(o.LOG_MINOR,"Auth.getToken()","token received"),l(O)})})})}async createTokenRequest(t,e){e=e||this.authOptions,t=t||ee(this.tokenParams);let n=e.key;if(!n)throw new f("No key specified",40101,403);let r=n.split(":"),i=r[0],a=r[1];if(!a)throw new f("Invalid key specified",40101,403);if(t.clientId==="")throw new f("clientId can\u2019t be an empty string",40012,400);"capability"in t&&(t.capability=Is(t.capability));let c=P({keyName:i},t),l=t.clientId||"",u=t.ttl||"",p=t.capability||"";c.timestamp||(c.timestamp=await this.getTimestamp(e&&e.queryTime));let h=c.nonce||(c.nonce=Fr()),g=c.timestamp,m=c.keyName+`
`+u+`
`+p+`
`+l+`
`+g+`
`+h+`
`;return c.mac=c.mac||Vr(m,a),o.logAction(o.LOG_MINOR,"Auth.getTokenRequest()","generated signed request"),c}async getAuthParams(){if(this.method=="basic")return{key:this.key};{let t=await this._ensureValidAuthCredentials(!1);if(!t)throw new Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{access_token:t.token}}}async getAuthHeaders(){if(this.method=="basic")return{authorization:"Basic "+this.basicKey};{let t=await this._ensureValidAuthCredentials(!1);if(!t)throw new Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{authorization:"Bearer "+Re(t.token)}}}async getTimestamp(t){return!this.isTimeOffsetSet()&&(t||this.authOptions.queryTime)?this.client.time():this.getTimestampUsingOffset()}getTimestampUsingOffset(){return Date.now()+(this.client.serverTimeOffset||0)}isTimeOffsetSet(){return this.client.serverTimeOffset!==null}_saveBasicOptions(t){this.method="basic",this.key=t.key,this.basicKey=Re(t.key),this.authOptions=t||{},"clientId"in t&&this._userSetClientId(t.clientId)}_saveTokenOptions(t,e){this.method="token",t&&(this.tokenParams=t),e&&(e.token&&(e.tokenDetails=typeof e.token=="string"?{token:e.token}:e.token),e.tokenDetails&&(this.tokenDetails=e.tokenDetails),"clientId"in e&&this._userSetClientId(e.clientId),this.authOptions=e)}async _ensureValidAuthCredentials(t){let e=this.tokenDetails;if(e){if(this._tokenClientIdMismatch(e.clientId))throw new f("Mismatch between clientId in token ("+e.clientId+") and current clientId ("+this.clientId+")",40102,403);if(!this.isTimeOffsetSet()||!e.expires||e.expires>=this.getTimestampUsingOffset())return o.logAction(o.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+e.expires),e;o.logAction(o.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.tokenDetails=null}let n=(this.waitingForTokenRequest||(this.waitingForTokenRequest=Pe.create())).createPromise();if(this.currentTokenRequestId!==null&&!t)return n;let r=this.currentTokenRequestId=Jr(),i,a=null;try{i=await this.requestToken(this.tokenParams,this.authOptions)}catch(l){a=l}if(this.currentTokenRequestId>r)return o.logAction(o.LOG_MINOR,"Auth._ensureValidAuthCredentials()","Discarding token request response; overtaken by newer one"),n;this.currentTokenRequestId=null;let c=this.waitingForTokenRequest;return this.waitingForTokenRequest=null,a?(c==null||c.rejectAll(a),n):(c==null||c.resolveAll(this.tokenDetails=i),n)}_userSetClientId(t){if(typeof t=="string"||t===null){if(t==="*")throw new f('Can\u2019t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, instantiate the library with {defaultTokenParams: {clientId: "*"}}), or if calling authorize(), pass it in as a tokenParam: authorize({clientId: "*"}, authOptions)',40012,400);{let e=this._uncheckedSetClientId(t);if(e)throw e}}else throw new f("clientId must be either a string or null",40012,400)}_uncheckedSetClientId(t){if(this._tokenClientIdMismatch(t)){let e="Unexpected clientId mismatch: client has "+this.clientId+", requested "+t,n=new f(e,40102,401);return o.logAction(o.LOG_ERROR,"Auth._uncheckedSetClientId()",e),n}else return this.clientId=this.tokenParams.clientId=t,null}_tokenClientIdMismatch(t){return!!(this.clientId&&this.clientId!=="*"&&t&&t!=="*"&&this.clientId!==t)}static isTokenErr(t){return t.code&&t.code>=40140&&t.code<40150}revokeTokens(t,e){return this.client.rest.revokeTokens(t,e)}},W=Qt;function at(s){let t=[];if(s)for(let e in s)t.push(e+"="+s[e]);return t.join("&")}function me(s,t){return s+(t?"?":"")+at(t)}function Qr(s,t,e,n){s.error?o.logActionNoStrip(o.LOG_MICRO,"Http."+t+"()","Received Error; "+me(e,n)+"; Error: "+A(s.error)):o.logActionNoStrip(o.LOG_MICRO,"Http."+t+"()","Received; "+me(e,n)+"; Headers: "+at(s.headers)+"; StatusCode: "+s.statusCode+"; Body"+(d.BufferUtils.isBuffer(s.body)?" (Base64): "+d.BufferUtils.base64Encode(s.body):": "+s.body))}function Xr(s,t,e,n){o.shouldLog(o.LOG_MICRO)&&o.logActionNoStrip(o.LOG_MICRO,"Http."+s+"()","Sending; "+me(t,n)+"; Body"+(d.BufferUtils.isBuffer(e)?" (Base64): "+d.BufferUtils.base64Encode(e):": "+e))}var ue=class{constructor(t){this.client=t;this.platformHttp=new d.Http(t),this.checkConnectivity=this.platformHttp.checkConnectivity?()=>this.platformHttp.checkConnectivity():void 0}get supportsAuthHeaders(){return this.platformHttp.supportsAuthHeaders}get supportsLinkHeaders(){return this.platformHttp.supportsLinkHeaders}_getHosts(t){let e=t.connection,n=e&&e.connectionManager.host;return n?[n].concat(R.getFallbackHosts(t.options)):R.getHosts(t.options)}async do(t,e,n,r,i){try{let a=this.client;if(!a)return{error:new f("http.do called without client",5e4,500)};let c=typeof e=="function"?e:function(h){return a.baseUri(h)+e},l=a._currentFallback;if(l)if(l.validUntil>Date.now()){let h=await this.doUri(t,c(l.host),n,r,i);return h.error&&this.platformHttp.shouldFallback(h.error)?(a._currentFallback=null,this.do(t,e,n,r,i)):h}else a._currentFallback=null;let u=this._getHosts(a);if(u.length===1)return this.doUri(t,c(u[0]),n,r,i);let p=async(h,g)=>{let m=h.shift(),y=await this.doUri(t,c(m),n,r,i);return y.error&&this.platformHttp.shouldFallback(y.error)&&h.length?p(h,!0):(g&&(a._currentFallback={host:m,validUntil:Date.now()+a.options.timeouts.fallbackRetryTimeout}),y)};return p(u)}catch(a){return{error:new f(`Unexpected error in Http.do: ${A(a)}`,500,5e4)}}}async doUri(t,e,n,r,i){try{Xr(t,e,r,i);let a=await this.platformHttp.doUri(t,e,n,r,i);return o.shouldLog(o.LOG_MICRO)&&Qr(a,t,e,i),a}catch(a){return{error:new f(`Unexpected error in Http.doUri: ${A(a)}`,500,5e4)}}}};var ct=class{constructor(t){var n,r,i,a,c,l,u,p;this._additionalHTTPRequestImplementations=(n=t.plugins)!=null?n:null,o.setLog(t.logLevel,t.logHandler),o.logAction(o.LOG_MICRO,"BaseClient()","initialized with clientOptions "+d.Config.inspect(t)),this._MsgPack=(i=(r=t.plugins)==null?void 0:r.MsgPack)!=null?i:null;let e=this.options=R.normaliseOptions(t,this._MsgPack);if(e.key){let h=e.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!h){let g="invalid key parameter";throw o.logAction(o.LOG_ERROR,"BaseClient()",g),new f(g,40400,404)}e.keyName=h[1],e.keySecret=h[2]}if("clientId"in e)if(typeof e.clientId=="string"||e.clientId===null){if(e.clientId==="*")throw new f('Can\u2019t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, use {defaultTokenParams: {clientId: "*"}})',40012,400)}else throw new f("clientId must be either a string or null",40012,400);o.logAction(o.LOG_MINOR,"BaseClient()","started; version = "+R.version),this._currentFallback=null,this.serverTimeOffset=null,this.http=new ue(this),this.auth=new W(this,e),this._rest=(a=t.plugins)!=null&&a.Rest?new t.plugins.Rest(this):null,this._Crypto=(l=(c=t.plugins)==null?void 0:c.Crypto)!=null?l:null,this.__FilteredSubscriptions=(p=(u=t.plugins)==null?void 0:u.MessageInteractions)!=null?p:null}get rest(){return this._rest||D("Rest"),this._rest}get _FilteredSubscriptions(){return this.__FilteredSubscriptions||D("MessageInteractions"),this.__FilteredSubscriptions}get channels(){return this.rest.channels}get push(){return this.rest.push}baseUri(t){return R.getHttpScheme(this.options)+t+":"+R.getPort(this.options,!1)}async stats(t){return this.rest.stats(t)}async time(t){return this.rest.time(t)}async request(t,e,n,r,i,a){return this.rest.request(t,e,n,r,i,a)}batchPublish(t){return this.rest.batchPublish(t)}batchPresence(t){return this.rest.batchPresence(t)}setLog(t){o.setLog(t.level,t.handler)}};ct.Platform=d;var lt=ct;var $t=class s{toJSON(){var t,e,n;return{id:this.id,deviceSecret:this.deviceSecret,platform:this.platform,formFactor:this.formFactor,clientId:this.clientId,metadata:this.metadata,deviceIdentityToken:this.deviceIdentityToken,push:{recipient:(t=this.push)==null?void 0:t.recipient,state:(e=this.push)==null?void 0:e.state,error:(n=this.push)==null?void 0:n.error}}}toString(){var e,n,r,i;let t="[DeviceDetails";return this.id&&(t+="; id="+this.id),this.platform&&(t+="; platform="+this.platform),this.formFactor&&(t+="; formFactor="+this.formFactor),this.clientId&&(t+="; clientId="+this.clientId),this.metadata&&(t+="; metadata="+this.metadata),this.deviceIdentityToken&&(t+="; deviceIdentityToken="+JSON.stringify(this.deviceIdentityToken)),(e=this.push)!=null&&e.recipient&&(t+="; push.recipient="+JSON.stringify(this.push.recipient)),(n=this.push)!=null&&n.state&&(t+="; push.state="+this.push.state),(r=this.push)!=null&&r.error&&(t+="; push.error="+JSON.stringify(this.push.error)),(i=this.push)!=null&&i.metadata&&(t+="; push.metadata="+this.push.metadata),t+="]",t}static toRequestBody(t,e,n){return G(t,e,n)}static fromResponseBody(t,e,n){return n&&(t=q(t,e,n)),Array.isArray(t)?s.fromValuesArray(t):s.fromValues(t)}static fromValues(t){return t.error=t.error&&f.fromValues(t.error),Object.assign(new s,t)}static fromValuesArray(t){let e=t.length,n=new Array(e);for(let r=0;r<e;r++)n[r]=s.fromValues(t[r]);return n}},He=$t;async function As(s,t,e,n){if(s.http.supportsAuthHeaders){let r=await s.auth.getAuthHeaders();return n(P(r,t),e)}else{let r=await s.auth.getAuthParams();return n(t,P(r,e))}}function $r(s,t,e){if(s.err&&!s.body)return{err:s.err};if(s.statusCode===le.NoContent)return J(x({},s),{body:[],unpacked:!0});let n=s.body;if(!s.unpacked)try{n=q(n,t,e)}catch(c){return Be(c)?{err:c}:{err:new S(A(c),null)}}if(!n)return{err:new S("unenvelope(): Response body is missing",null)};let{statusCode:r,response:i,headers:a}=n;if(r===void 0)return J(x({},s),{body:n,unpacked:!0});if(r<200||r>=300){let c=i&&i.error||s.err;return c||(c=new Error("Error in unenveloping "+n),c.statusCode=r),{err:c,body:i,headers:a,unpacked:!0,statusCode:r}}return{err:s.err,body:i,headers:a,unpacked:!0,statusCode:r}}function Yr(s,t,e,n){s.err?o.logAction(o.LOG_MICRO,"Resource."+t+"()","Received Error; "+me(e,n)+"; Error: "+A(s.err)):o.logAction(o.LOG_MICRO,"Resource."+t+"()","Received; "+me(e,n)+"; Headers: "+at(s.headers)+"; StatusCode: "+s.statusCode+"; Body: "+(d.BufferUtils.isBuffer(s.body)?" (Base64): "+d.BufferUtils.base64Encode(s.body):": "+d.Config.inspect(s.body)))}var Yt=class s{static async get(t,e,n,r,i,a){return s.do(E.Get,t,e,null,n,r,i,a!=null?a:!1)}static async delete(t,e,n,r,i,a){return s.do(E.Delete,t,e,null,n,r,i,a)}static async post(t,e,n,r,i,a,c){return s.do(E.Post,t,e,n,r,i,a,c)}static async patch(t,e,n,r,i,a,c){return s.do(E.Patch,t,e,n,r,i,a,c)}static async put(t,e,n,r,i,a,c){return s.do(E.Put,t,e,n,r,i,a,c)}static async do(t,e,n,r,i,a,c,l){c&&((a=a||{}).envelope=c);async function u(h,g){var y;if(o.shouldLog(o.LOG_MICRO)){let b=r;if(((y=h["content-type"])==null?void 0:y.indexOf("msgpack"))>0)try{e._MsgPack||D("MsgPack"),b=e._MsgPack.decode(r)}catch(I){o.logAction(o.LOG_MICRO,"Resource."+t+"()","Sending MsgPack Decoding Error: "+A(I))}o.logAction(o.LOG_MICRO,"Resource."+t+"()","Sending; "+me(n,g)+"; Body: "+b)}let m=await e.http.do(t,n,h,r,g);return m.error&&W.isTokenErr(m.error)?(await e.auth.authorize(null,null),As(e,h,g,u)):{err:m.error,body:m.body,headers:m.headers,unpacked:m.unpacked,statusCode:m.statusCode}}let p=await As(e,i,a,u);if(c&&(p=$r(p,e._MsgPack,c)),o.shouldLog(o.LOG_MICRO)&&Yr(p,t,n,a),l){if(p.err)throw p.err;{let h=x({},p);return delete h.err,h}}return p}},U=Yt;function Zr(s){let t=s.match(/^\.\/(\w+)\?(.*)$/);return t&&t[2]&&pe(t[2])}function ei(s){typeof s=="string"&&(s=s.split(","));let t={};for(let e=0;e<s.length;e++){let n=s[e].match(/^\s*<(.+)>;\s*rel="(\w+)"$/);if(n){let r=Zr(n[1]);r&&(t[n[2]]=r)}}return t}function ti(s,t,e){return!(e&&(t||typeof s.code=="number"))}var Zt=class{constructor(t,e,n,r,i,a){this.client=t,this.path=e,this.headers=n,this.envelope=r!=null?r:null,this.bodyHandler=i,this.useHttpPaginatedResponse=a||!1}async get(t){let e=await U.get(this.client,this.path,this.headers,t,this.envelope,!1);return this.handlePage(e)}async delete(t){let e=await U.delete(this.client,this.path,this.headers,t,this.envelope,!1);return this.handlePage(e)}async post(t,e){let n=await U.post(this.client,this.path,e,this.headers,t,this.envelope,!1);return this.handlePage(n)}async put(t,e){let n=await U.put(this.client,this.path,e,this.headers,t,this.envelope,!1);return this.handlePage(n)}async patch(t,e){let n=await U.patch(this.client,this.path,e,this.headers,t,this.envelope,!1);return this.handlePage(n)}async handlePage(t){if(t.err&&ti(t.err,t.body,this.useHttpPaginatedResponse))throw o.logAction(o.LOG_ERROR,"PaginatedResource.handlePage()","Unexpected error getting resource: err = "+A(t.err)),t.err;let e,n,r;try{e=t.statusCode==le.NoContent?[]:await this.bodyHandler(t.body,t.headers||{},t.unpacked)}catch(i){throw t.err||i}return t.headers&&(n=t.headers.Link||t.headers.link)&&(r=ei(n)),this.useHttpPaginatedResponse?new en(this,e,t.headers||{},t.statusCode,r,t.err):new ut(this,e,r)}},ut=class{constructor(t,e,n){this.resource=t,this.items=e;let r=this;n&&("first"in n&&(this.first=async function(){return r.get(n.first)}),"current"in n&&(this.current=async function(){return r.get(n.current)}),this.next=async function(){return"next"in n?r.get(n.next):null},this.hasNext=function(){return"next"in n},this.isLast=()=>{var i;return!((i=this.hasNext)!=null&&i.call(this))})}async get(t){let e=this.resource,n=await U.get(e.client,e.path,e.headers,t,e.envelope,!1);return e.handlePage(n)}},en=class extends ut{constructor(e,n,r,i,a,c){super(e,n,a);this.statusCode=i,this.success=i<300&&i>=200,this.headers=r,this.errorCode=c&&c.code,this.errorMessage=c&&c.message}toJSON(){return{items:this.items,statusCode:this.statusCode,success:this.success,headers:this.headers,errorCode:this.errorCode,errorMessage:this.errorMessage}}},z=Zt;var ge=class ge{toJSON(){return{channel:this.channel,deviceId:this.deviceId,clientId:this.clientId}}toString(){let t="[PushChannelSubscription";return this.channel&&(t+="; channel="+this.channel),this.deviceId&&(t+="; deviceId="+this.deviceId),this.clientId&&(t+="; clientId="+this.clientId),t+="]",t}static fromResponseBody(t,e,n){return n&&(t=q(t,e,n)),Array.isArray(t)?ge.fromValuesArray(t):ge.fromValues(t)}static fromValues(t){return Object.assign(new ge,t)}static fromValuesArray(t){let e=t.length,n=new Array(e);for(let r=0;r<e;r++)n[r]=ge.fromValues(t[r]);return n}};ge.toRequestBody=G;var tn=ge,ht=tn;var nn=class{constructor(t){this.client=t,this.admin=new sn(t)}},sn=class{constructor(t){this.client=t,this.deviceRegistrations=new rn(t),this.channelSubscriptions=new on(t)}async publish(t,e){let n=this.client,r=n.options.useBinaryProtocol?"msgpack":"json",i=R.defaultPostHeaders(n.options,{format:r}),a={},c=P({recipient:t},e);P(i,n.options.headers),n.options.pushFullWait&&P(a,{fullWait:"true"});let l=G(c,n._MsgPack,r);await U.post(n,"/push/publish",l,i,a,null,!0)}},rn=class{constructor(t){this.client=t}async save(t){let e=this.client,n=He.fromValues(t),r=e.options.useBinaryProtocol?"msgpack":"json",i=R.defaultPostHeaders(e.options,{format:r}),a={};P(i,e.options.headers),e.options.pushFullWait&&P(a,{fullWait:"true"});let c=G(n,e._MsgPack,r),l=await U.put(e,"/push/deviceRegistrations/"+encodeURIComponent(t.id),c,i,a,null,!0);return He.fromResponseBody(l.body,e._MsgPack,l.unpacked?void 0:r)}async get(t){let e=this.client,n=e.options.useBinaryProtocol?"msgpack":"json",r=R.defaultGetHeaders(e.options,{format:n}),i=t.id||t;if(typeof i!="string"||!i.length)throw new f("First argument to DeviceRegistrations#get must be a deviceId string or DeviceDetails",4e4,400);P(r,e.options.headers);let a=await U.get(e,"/push/deviceRegistrations/"+encodeURIComponent(i),r,{},null,!0);return He.fromResponseBody(a.body,e._MsgPack,a.unpacked?void 0:n)}async list(t){let e=this.client,n=e.options.useBinaryProtocol?"msgpack":"json",r=this.client.http.supportsLinkHeaders?void 0:n,i=R.defaultGetHeaders(e.options,{format:n});return P(i,e.options.headers),new z(e,"/push/deviceRegistrations",i,r,async function(a,c,l){return He.fromResponseBody(a,e._MsgPack,l?void 0:n)}).get(t)}async remove(t){let e=this.client,n=e.options.useBinaryProtocol?"msgpack":"json",r=R.defaultGetHeaders(e.options,{format:n}),i={},a=t.id||t;if(typeof a!="string"||!a.length)throw new f("First argument to DeviceRegistrations#remove must be a deviceId string or DeviceDetails",4e4,400);P(r,e.options.headers),e.options.pushFullWait&&P(i,{fullWait:"true"}),await U.delete(e,"/push/deviceRegistrations/"+encodeURIComponent(a),r,i,null,!0)}async removeWhere(t){let e=this.client,n=e.options.useBinaryProtocol?"msgpack":"json",r=R.defaultGetHeaders(e.options,{format:n});P(r,e.options.headers),e.options.pushFullWait&&P(t,{fullWait:"true"}),await U.delete(e,"/push/deviceRegistrations",r,t,null,!0)}},on=class s{constructor(t){this.remove=s.prototype.removeWhere;this.client=t}async save(t){let e=this.client,n=ht.fromValues(t),r=e.options.useBinaryProtocol?"msgpack":"json",i=R.defaultPostHeaders(e.options,{format:r}),a={};P(i,e.options.headers),e.options.pushFullWait&&P(a,{fullWait:"true"});let c=G(n,e._MsgPack,r),l=await U.post(e,"/push/channelSubscriptions",c,i,a,null,!0);return ht.fromResponseBody(l.body,e._MsgPack,l.unpacked?void 0:r)}async list(t){let e=this.client,n=e.options.useBinaryProtocol?"msgpack":"json",r=this.client.http.supportsLinkHeaders?void 0:n,i=R.defaultGetHeaders(e.options,{format:n});return P(i,e.options.headers),new z(e,"/push/channelSubscriptions",i,r,async function(a,c,l){return ht.fromResponseBody(a,e._MsgPack,l?void 0:n)}).get(t)}async removeWhere(t){let e=this.client,n=e.options.useBinaryProtocol?"msgpack":"json",r=R.defaultGetHeaders(e.options,{format:n});P(r,e.options.headers),e.options.pushFullWait&&P(t,{fullWait:"true"}),await U.delete(e,"/push/channelSubscriptions",r,t,null,!0)}async listChannels(t){let e=this.client,n=e.options.useBinaryProtocol?"msgpack":"json",r=this.client.http.supportsLinkHeaders?void 0:n,i=R.defaultGetHeaders(e.options,{format:n});return P(i,e.options.headers),e.options.pushFullWait&&P(t,{fullWait:"true"}),new z(e,"/push/channels",i,r,async function(a,c,l){let u=!l&&n?q(a,e._MsgPack,n):a;for(let p=0;p<u.length;p++)u[p]=String(u[p]);return u}).get(t)}},ws=nn;function ni(s){return!s||!s.channelOptions?{channelOptions:s,plugins:{},baseEncodedPreviousPayload:void 0}:s}function si(s,t){if(t&&t.cipher){s||D("Crypto");let e=s.getCipher(t.cipher);return{cipher:e.cipherParams,channelCipher:e.cipher}}return t!=null?t:{}}function ri(s){let t=0;return s.name&&(t+=s.name.length),s.clientId&&(t+=s.clientId.length),s.extras&&(t+=JSON.stringify(s.extras).length),s.data&&(t+=Ht(s.data)),t}async function an(s,t,e){let n=Z(t),r=si(s,e!=null?e:null);try{await he(n,r)}catch(i){o.logAction(o.LOG_ERROR,"Message.fromEncoded()",i.toString())}return n}async function Os(s,t,e){return Promise.all(t.map(function(n){return an(s,n,e)}))}async function ii(s,t){let e=s.data,n=s.encoding,r=t.channelCipher;n=n?n+"/":"",d.BufferUtils.isBuffer(e)||(e=d.BufferUtils.utf8Encode(String(e)),n=n+"utf-8/");let i=await r.encrypt(e);return s.data=i,s.encoding=n+"cipher+"+r.algorithm,s}async function Ce(s,t){let e=s.data;if(!(typeof e=="string"||d.BufferUtils.isBuffer(e)||e===null||e===void 0))if(te(e)||Array.isArray(e))s.data=JSON.stringify(e),s.encoding=s.encoding?s.encoding+"/json":"json";else throw new f("Data type is unsupported",40013,400);return t!=null&&t.cipher?ii(s,t):s}async function ft(s,t){return Promise.all(s.map(e=>Ce(e,t)))}var Ms=G;async function he(s,t){let e=ni(t),n=s.data,r=s.encoding;if(r){let i=r.split("/"),a,c=i.length,l=s.data,u="";try{for(;(a=c)>0;){let p=i[--c].match(/([-\w]+)(\+([\w-]+))?/);if(!p)break;switch(u=p[1],u){case"base64":l=d.BufferUtils.base64Decode(String(l)),a==i.length&&(n=l);continue;case"utf-8":l=d.BufferUtils.utf8Decode(l);continue;case"json":l=JSON.parse(l);continue;case"cipher":if(e.channelOptions!=null&&e.channelOptions.cipher&&e.channelOptions.channelCipher){let h=p[3],g=e.channelOptions.channelCipher;if(h!=g.algorithm)throw new Error("Unable to decrypt message with given cipher; incompatible cipher params");l=await g.decrypt(l);continue}else throw new Error("Unable to decrypt message; not an encrypted channel");case"vcdiff":if(!e.plugins||!e.plugins.vcdiff)throw new f("Missing Vcdiff decoder (https://github.com/ably-forks/vcdiff-decoder)",40019,400);if(typeof Uint8Array=="undefined")throw new f("Delta decoding not supported on this browser (need ArrayBuffer & Uint8Array)",40020,400);try{let h=e.baseEncodedPreviousPayload;typeof h=="string"&&(h=d.BufferUtils.utf8Encode(h));let g=d.BufferUtils.toBuffer(h);l=d.BufferUtils.toBuffer(l),l=d.BufferUtils.arrayBufferViewToBuffer(e.plugins.vcdiff.decode(l,g)),n=l}catch(h){throw new f("Vcdiff delta decode failed with "+h,40018,400)}continue;default:throw new Error("Unknown encoding")}}}catch(p){let h=p;throw new f("Error processing the "+u+" encoding, decoder returned \u2018"+h.message+"\u2019",h.code||40013,400)}finally{s.encoding=a<=0?null:i.slice(0,a).join("/"),s.data=l}}e.baseEncodedPreviousPayload=n}async function Ss(s,t,e,n){n&&(s=q(s,e,n));for(let r=0;r<s.length;r++){let i=s[r]=Z(s[r]);try{await he(i,t)}catch(a){o.logAction(o.LOG_ERROR,"Message.fromResponseBody()",a.toString())}}return s}function Z(s){return Object.assign(new dt,s)}function Te(s){let t=s.length,e=new Array(t);for(let n=0;n<t;n++)e[n]=Z(s[n]);return e}function ye(s){let t,e=0;for(let n=0;n<s.length;n++)t=s[n],e+=t.size||(t.size=ri(t));return e}var dt=class{toJSON(){let t=this.encoding,e=this.data;return e&&d.BufferUtils.isBuffer(e)&&(arguments.length>0?(t=t?t+"/base64":"base64",e=d.BufferUtils.base64Encode(e)):e=d.BufferUtils.toBuffer(e)),{name:this.name,id:this.id,clientId:this.clientId,connectionId:this.connectionId,connectionKey:this.connectionKey,extras:this.extras,encoding:t,data:e}}toString(){let t="[Message";return this.name&&(t+="; name="+this.name),this.id&&(t+="; id="+this.id),this.timestamp&&(t+="; timestamp="+this.timestamp),this.clientId&&(t+="; clientId="+this.clientId),this.connectionId&&(t+="; connectionId="+this.connectionId),this.encoding&&(t+="; encoding="+this.encoding),this.extras&&(t+="; extras ="+JSON.stringify(this.extras)),this.data&&(typeof this.data=="string"?t+="; data="+this.data:d.BufferUtils.isBuffer(this.data)?t+="; data (buffer)="+d.BufferUtils.base64Encode(this.data):t+="; data (json)="+JSON.stringify(this.data)),this.extras&&(t+="; extras="+JSON.stringify(this.extras)),t+="]",t}},cn=dt;var Es=["absent","present","enter","leave","update"];function oi(s){return Es.indexOf(s)}async function ln(s,t){let e=j(s,!0);try{await pt(e,t!=null?t:{})}catch(n){o.logAction(o.LOG_ERROR,"PresenceMessage.fromEncoded()",n.toString())}return e}async function vs(s,t){return Promise.all(s.map(function(e){return ln(e,t)}))}function j(s,t){return t&&(s.action=Es[s.action]),Object.assign(new Ge,s)}var pt=he;async function mt(s,t,e,n){let r=[];n&&(s=q(s,e,n));for(let i=0;i<s.length;i++){let a=r[i]=j(s[i],!0);try{await pt(a,t)}catch(c){o.logAction(o.LOG_ERROR,"PresenceMessage.fromResponseBody()",c.toString())}}return r}function gt(s){let t=s.length,e=new Array(t);for(let n=0;n<t;n++)e[n]=j(s[n]);return e}function un(s){return s instanceof Ge?s:j({data:s})}var Ge=class{isSynthesized(){return!this.id||!this.connectionId?!0:this.id.substring(this.connectionId.length,0)!==this.connectionId}parseId(){if(!this.id)throw new Error("parseId(): Presence message does not contain an id");let t=this.id.split(":");return{connectionId:t[0],msgSerial:parseInt(t[1],10),index:parseInt(t[2],10)}}toJSON(){let t=this.data,e=this.encoding;return t&&d.BufferUtils.isBuffer(t)&&(arguments.length>0?(e=e?e+"/base64":"base64",t=d.BufferUtils.base64Encode(t)):t=d.BufferUtils.toBuffer(t)),{id:this.id,clientId:this.clientId,action:oi(this.action),data:t,encoding:e,extras:this.extras}}toString(){let t="[PresenceMessage";return t+="; action="+this.action,this.id&&(t+="; id="+this.id),this.timestamp&&(t+="; timestamp="+this.timestamp),this.clientId&&(t+="; clientId="+this.clientId),this.connectionId&&(t+="; connectionId="+this.connectionId),this.encoding&&(t+="; encoding="+this.encoding),this.data&&(typeof this.data=="string"?t+="; data="+this.data:d.BufferUtils.isBuffer(this.data)?t+="; data (buffer)="+d.BufferUtils.base64Encode(this.data):t+="; data (json)="+JSON.stringify(this.data)),this.extras&&(t+="; extras="+JSON.stringify(this.extras)),t+="]",t}},xs=Ge;var hn=class{constructor(t){this.channel=t}async get(t){o.logAction(o.LOG_MICRO,"RestPresence.get()","channel = "+this.channel.name);let e=this.channel.client,n=e.options.useBinaryProtocol?"msgpack":"json",r=this.channel.client.http.supportsLinkHeaders?void 0:n,i=R.defaultGetHeaders(e.options,{format:n});P(i,e.options.headers);let a=this.channel.channelOptions;return new z(e,this.channel.client.rest.presenceMixin.basePath(this),i,r,async function(c,l,u){return await mt(c,a,e._MsgPack,u?void 0:n)}).get(t)}async history(t){return o.logAction(o.LOG_MICRO,"RestPresence.history()","channel = "+this.channel.name),this.channel.client.rest.presenceMixin.history(this,t)}},Us=hn;var ai=9;function ci(s){return s.every(function(t){return!t.id})}var dn=class{constructor(t,e,n){var r;o.logAction(o.LOG_MINOR,"RestChannel()","started; name = "+e),this.name=e,this.client=t,this.presence=new Us(this),this.channelOptions=be((r=t._Crypto)!=null?r:null,n)}setOptions(t){var e;this.channelOptions=be((e=this.client._Crypto)!=null?e:null,t)}async history(t){return o.logAction(o.LOG_MICRO,"RestChannel.history()","channel = "+this.name),this.client.rest.channelMixin.history(this,t)}async publish(...t){let e=t[0],n=t[1],r,i;if(typeof e=="string"||e===null)r=[Z({name:e,data:n})],i=t[2];else if(te(e))r=[Z(e)],i=t[1];else if(Array.isArray(e))r=Te(e),i=t[1];else throw new f("The single-argument form of publish() expects a message object or an array of message objects",40013,400);i||(i={});let a=this.client,c=a.options,l=c.useBinaryProtocol?"msgpack":"json",u=a.options.idempotentRestPublishing,p=R.defaultPostHeaders(a.options,{format:l});if(P(p,c.headers),u&&ci(r)){let m=await Gt(ai);r.forEach(function(y,b){y.id=m+":"+b.toString()})}await ft(r,this.channelOptions);let h=ye(r),g=c.maxMessageSize;if(h>g)throw new f("Maximum size of messages that can be published at once exceeded ( was "+h+" bytes; limit is "+g+" bytes)",40009,400);await this._publish(Ms(r,a._MsgPack,l),p,i)}async _publish(t,e,n){await U.post(this.client,this.client.rest.channelMixin.basePath(this)+"/messages",t,e,n,null,!0)}async status(){return this.client.rest.channelMixin.status(this)}},Bs=dn;var fn=class s{constructor(t){this.entries=t&&t.entries||void 0,this.schema=t&&t.schema||void 0,this.appId=t&&t.appId||void 0,this.inProgress=t&&t.inProgress||void 0,this.unit=t&&t.unit||void 0,this.intervalId=t&&t.intervalId||void 0}static fromValues(t){return new s(t)}},_s=fn;var Ie=class{static basePath(t){return"/channels/"+encodeURIComponent(t.name)}static history(t,e){let n=t.client,r=n.options.useBinaryProtocol?"msgpack":"json",i=t.client.http.supportsLinkHeaders?void 0:r,a=R.defaultGetHeaders(n.options,{format:r});P(a,n.options.headers);let c=t.channelOptions;return new z(n,this.basePath(t)+"/messages",a,i,async function(l,u,p){return await Ss(l,c,n._MsgPack,p?void 0:r)}).get(e)}static async status(t){let e=t.client.options.useBinaryProtocol?"msgpack":"json",n=R.defaultPostHeaders(t.client.options,{format:e});return(await U.get(t.client,this.basePath(t),n,{},e,!0)).body}};var yt=class{static basePath(t){return Ie.basePath(t.channel)+"/presence"}static async history(t,e){let n=t.channel.client,r=n.options.useBinaryProtocol?"msgpack":"json",i=t.channel.client.http.supportsLinkHeaders?void 0:r,a=R.defaultGetHeaders(n.options,{format:r});P(a,n.options.headers);let c=t.channel.channelOptions;return new z(n,this.basePath(t)+"/history",a,i,async function(l,u,p){return await mt(l,c,n._MsgPack,p?void 0:r)}).get(e)}};var ke=class{constructor(t){this.channelMixin=Ie;this.presenceMixin=yt;this.client=t,this.channels=new pn(this.client),this.push=new ws(this.client)}async stats(t){let e=R.defaultGetHeaders(this.client.options),n=this.client.options.useBinaryProtocol?"msgpack":"json",r=this.client.http.supportsLinkHeaders?void 0:n;return P(e,this.client.options.headers),new z(this.client,"/stats",e,r,function(i,a,c){let l=c?i:JSON.parse(i);for(let u=0;u<l.length;u++)l[u]=_s.fromValues(l[u]);return l}).get(t)}async time(t){let e=R.defaultGetHeaders(this.client.options);this.client.options.headers&&P(e,this.client.options.headers);let n=l=>this.client.baseUri(l)+"/time",{error:r,body:i,unpacked:a}=await this.client.http.do(E.Get,n,e,null,t);if(r)throw r;a||(i=JSON.parse(i));let c=i[0];if(!c)throw new f("Internal error (unexpected result type from GET /time)",5e4,500);return this.client.serverTimeOffset=c-Date.now(),c}async request(t,e,n,r,i,a){var y;let[c,l,u]=(()=>this.client.options.useBinaryProtocol?(this.client._MsgPack||D("MsgPack"),[this.client._MsgPack.encode,this.client._MsgPack.decode,"msgpack"]):[JSON.stringify,JSON.parse,"json"])(),p=this.client.http.supportsLinkHeaders?void 0:u;r=r||{};let h=t.toLowerCase(),g=h=="get"?R.defaultGetHeaders(this.client.options,{format:u,protocolVersion:n}):R.defaultPostHeaders(this.client.options,{format:u,protocolVersion:n});typeof i!="string"&&(i=(y=c(i))!=null?y:null),P(g,this.client.options.headers),a&&P(g,a);let m=new z(this.client,e,g,p,async function(b,I,k){return Ut(k?b:l(b))},!0);if(!d.Http.methods.includes(h))throw new f("Unsupported method "+h,40500,405);return d.Http.methodsWithBody.includes(h)?m[h](r,i):m[h](r)}async batchPublish(t){let e,n;Array.isArray(t)?(e=t,n=!1):(e=[t],n=!0);let r=this.client.options.useBinaryProtocol?"msgpack":"json",i=R.defaultPostHeaders(this.client.options,{format:r});this.client.options.headers&&P(i,this.client.options.headers);let a=G(e,this.client._MsgPack,r),c=await U.post(this.client,"/messages",a,i,{},null,!0),l=c.unpacked?c.body:q(c.body,this.client._MsgPack,r);return n?l[0]:l}async batchPresence(t){let e=this.client.options.useBinaryProtocol?"msgpack":"json",n=R.defaultPostHeaders(this.client.options,{format:e});this.client.options.headers&&P(n,this.client.options.headers);let r=t.join(","),i=await U.get(this.client,"/presence",n,{channels:r},null,!0);return i.unpacked?i.body:q(i.body,this.client._MsgPack,e)}async revokeTokens(t,e){if(Xt(this.client.options))throw new f("Cannot revoke tokens when using token auth",40162,401);let n=this.client.options.keyName,r=e!=null?e:{},i=x({targets:t.map(p=>`${p.type}:${p.value}`)},r),a=this.client.options.useBinaryProtocol?"msgpack":"json",c=R.defaultPostHeaders(this.client.options,{format:a});this.client.options.headers&&P(c,this.client.options.headers);let l=G(i,this.client._MsgPack,a),u=await U.post(this.client,`/keys/${n}/revokeTokens`,l,c,{},null,!0);return u.unpacked?u.body:q(u.body,this.client._MsgPack,a)}setLog(t){o.setLog(t.level,t.handler)}},pn=class{constructor(t){this.client=t,this.all=Object.create(null)}get(t,e){t=String(t);let n=this.all[t];return n?e&&n.setOptions(e):this.all[t]=n=new Bs(this.client,t,e),n}release(t){delete this.all[String(t)]}};var Rt=class extends lt{constructor(t){super(R.objectifyOptions(t,!1,"BaseRest",{Rest:ke}))}};var bt={Rest:ke};var Ae=class extends cn{static async fromEncoded(t,e){return an(d.Crypto,t,e)}static async fromEncodedArray(t,e){return Os(d.Crypto,t,e)}static fromValues(t){return Object.assign(new cn,t)}static async encode(t,e){return Ce(t,e)}static async decode(t,e){return he(t,e)}};var we=class extends xs{static async fromEncoded(t,e){return ln(t,e)}static async fromEncodedArray(t,e){return vs(t,e)}static fromValues(t,e){return j(t,e)}};var se=class se extends Rt{constructor(t){var n,r;if(!se._MsgPack)throw new Error("Expected DefaultRest._MsgPack to have been set");super(R.objectifyOptions(t,!0,"Rest",J(x({},bt),{Crypto:(n=se.Crypto)!=null?n:void 0,MsgPack:(r=se._MsgPack)!=null?r:void 0})))}static get Crypto(){if(this._Crypto===null)throw new Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto(t){this._Crypto=t}};se._Crypto=null,se.Message=Ae,se.PresenceMessage=we,se._MsgPack=null,se._Http=ue;var Oe=se;function li(s,t,e){try{t.apply(s,e)}catch(n){o.logAction(o.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+n+"; stack = "+(n&&n.stack))}}function mn(s,t,e){let n,r,i;for(let a=0;a<s.length;a++)if(n=s[a],e&&(n=n[e]),Array.isArray(n)){for(;(r=n.indexOf(t))!==-1;)n.splice(r,1);e&&n.length===0&&delete s[a][e]}else if(te(n))for(i in n)Object.prototype.hasOwnProperty.call(n,i)&&Array.isArray(n[i])&&mn([n],t,i)}var gn=class{constructor(){this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null)}on(...t){if(t.length===1){let e=t[0];if(typeof e=="function")this.any.push(e);else throw new Error("EventListener.on(): Invalid arguments: "+d.Config.inspect(t))}if(t.length===2){let[e,n]=t;if(typeof n!="function")throw new Error("EventListener.on(): Invalid arguments: "+d.Config.inspect(t));if(Q(e))this.any.push(n);else if(Array.isArray(e))e.forEach(r=>{this.on(r,n)});else{if(typeof e!="string")throw new Error("EventListener.on(): Invalid arguments: "+d.Config.inspect(t));(this.events[e]||(this.events[e]=[])).push(n)}}}off(...t){if(t.length==0||Q(t[0])&&Q(t[1])){this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null);return}let[e,n]=t,r=null,i=null;if(t.length===1||!n)typeof e=="function"?r=e:i=e;else{if(typeof n!="function")throw new Error("EventEmitter.off(): invalid arguments:"+d.Config.inspect(t));[i,r]=[e,n]}if(r&&Q(i)){mn([this.any,this.events,this.anyOnce,this.eventsOnce],r);return}if(Array.isArray(i)){i.forEach(a=>{this.off(a,r)});return}if(typeof i!="string")throw new Error("EventEmitter.off(): invalid arguments:"+d.Config.inspect(t));r?mn([this.events,this.eventsOnce],r,i):(delete this.events[i],delete this.eventsOnce[i])}listeners(t){if(t){let e=this.events[t]||[];return this.eventsOnce[t]&&Array.prototype.push.apply(e,this.eventsOnce[t]),e.length?e:null}return this.any.length?this.any:null}emit(t,...e){let n={event:t},r=[];this.anyOnce.length&&(Array.prototype.push.apply(r,this.anyOnce),this.anyOnce=[]),this.any.length&&Array.prototype.push.apply(r,this.any);let i=this.eventsOnce[t];i&&(Array.prototype.push.apply(r,i),delete this.eventsOnce[t]);let a=this.events[t];a&&Array.prototype.push.apply(r,a),r.forEach(function(c){li(n,c,e)})}once(...t){let e=t.length;if(e===0||e===1&&typeof t[0]!="function"){let i=t[0];return new Promise(a=>{this.once(i,a)})}let[n,r]=t;if(t.length===1&&typeof n=="function")this.anyOnce.push(n);else if(Q(n)){if(typeof r!="function")throw new Error("EventEmitter.once(): Invalid arguments:"+d.Config.inspect(t));this.anyOnce.push(r)}else if(Array.isArray(n)){let i=this,a=function(){let c=Array.prototype.slice.call(arguments);if(n.forEach(function(l){i.off(l,a)}),typeof r!="function")throw new Error("EventEmitter.once(): Invalid arguments:"+d.Config.inspect(t));r.apply(this,c)};n.forEach(function(c){i.on(c,a)})}else{if(typeof n!="string")throw new Error("EventEmitter.once(): Invalid arguments:"+d.Config.inspect(t));let i=this.eventsOnce[n]||(this.eventsOnce[n]=[]);if(r){if(typeof r!="function")throw new Error("EventEmitter.once(): Invalid arguments:"+d.Config.inspect(t));i.push(r)}}}async whenState(t,e){if(typeof t!="string"||typeof e!="string")throw new Error("whenState requires a valid state String argument");return t===e?null:this.once(t)}},v=gn;var T={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16,AUTH:17,ACTIVATE:18},qs=[];Object.keys(T).forEach(function(s){qs[T[s]]=s});var oe={HAS_PRESENCE:1,HAS_BACKLOG:2,RESUMED:4,TRANSIENT:16,ATTACH_RESUME:32,PRESENCE:65536,PUBLISH:1<<17,SUBSCRIBE:1<<18,PRESENCE_SUBSCRIBE:1<<19},ui=Object.keys(oe);oe.MODE_ALL=oe.PRESENCE|oe.PUBLISH|oe.SUBSCRIBE|oe.PRESENCE_SUBSCRIBE;function Ls(s){let t=[];if(s)for(let e=0;e<s.length;e++)t.push(s[e].toString());return"[ "+t.join(", ")+" ]"}var yn=["PRESENCE","PUBLISH","SUBSCRIBE","PRESENCE_SUBSCRIBE"],Ns=G;function Hs(s,t,e,n){let r=q(s,t,n);return Pt(r,e)}function Pt(s,t){let e=s.error;e&&(s.error=f.fromValues(e));let n=s.messages;if(n)for(let i=0;i<n.length;i++)n[i]=Z(n[i]);let r=t?s.presence:void 0;if(t&&r&&t)for(let i=0;i<r.length;i++)r[i]=t.presenceMessageFromValues(r[i],!0);return Object.assign(new De,J(x({},s),{presence:r}))}function Gs(s){return Pt(s,{presenceMessageFromValues:j,presenceMessagesFromValuesArray:gt})}function V(s){return Object.assign(new De,s)}function Me(s,t){let e="[ProtocolMessage";s.action!==void 0&&(e+="; action="+qs[s.action]||s.action);let n=["id","channel","channelSerial","connectionId","count","msgSerial","timestamp"],r;for(let i=0;i<n.length;i++)r=n[i],s[r]!==void 0&&(e+="; "+r+"="+s[r]);if(s.messages&&(e+="; messages="+Ls(Te(s.messages))),s.presence&&t&&(e+="; presence="+Ls(t.presenceMessagesFromValuesArray(s.presence))),s.error&&(e+="; error="+f.fromValues(s.error).toString()),s.auth&&s.auth.accessToken&&(e+="; token="+s.auth.accessToken),s.flags&&(e+="; flags="+ui.filter(s.hasFlag).join(",")),s.params){let i="";Lt(s.params,function(a){i.length>0&&(i+="; "),i+=a+"="+s.params[a]}),i.length>0&&(e+="; params=["+i+"]")}return e+="]",e}var De=class{constructor(){this.hasFlag=t=>(this.flags&oe[t])>0}setFlag(t){return this.flags=this.flags|oe[t]}getMode(){return this.flags&&this.flags&oe.MODE_ALL}encodeModesToFlags(t){t.forEach(e=>this.setFlag(e))}decodeModesFromFlags(){let t=[];return yn.forEach(e=>{this.hasFlag(e)&&t.push(e)}),t.length>0?t:void 0}},Ct=De;var Rn=class extends v{constructor(){super();this.messages=[]}count(){return this.messages.length}push(e){this.messages.push(e)}shift(){return this.messages.shift()}last(){return this.messages[this.messages.length-1]}copyAll(){return this.messages.slice()}append(e){this.messages.push.apply(this.messages,e)}prepend(e){this.messages.unshift.apply(this.messages,e)}completeMessages(e,n,r){o.logAction(o.LOG_MICRO,"MessageQueue.completeMessages()","serial = "+e+"; count = "+n),r=r||null;let i=this.messages;if(i.length===0)throw new Error("MessageQueue.completeMessages(): completeMessages called on any empty MessageQueue");let a=i[0];if(a){let c=a.message.msgSerial,l=e+n;if(l>c){let u=i.splice(0,l-c);for(let p of u)p.callback(r)}i.length==0&&this.emit("idle")}}completeAllMessages(e){this.completeMessages(0,Number.MAX_SAFE_INTEGER||Number.MAX_VALUE,e)}resetSendAttempted(){for(let e of this.messages)e.sendAttempted=!1}clear(){o.logAction(o.LOG_MICRO,"MessageQueue.clear()","clearing "+this.messages.length+" messages"),this.messages=[],this.emit("idle")}},Tt=Rn;var Fe=class{constructor(t,e){this.message=t,this.callback=e,this.merged=!1;let n=t.action;this.sendAttempted=!1,this.ackRequired=n==T.MESSAGE||n==T.PRESENCE}},bn=class extends v{constructor(e){super();this.transport=e,this.messageQueue=new Tt,e.on("ack",(n,r)=>{this.onAck(n,r)}),e.on("nack",(n,r,i)=>{this.onNack(n,r,i)})}onAck(e,n){o.logAction(o.LOG_MICRO,"Protocol.onAck()","serial = "+e+"; count = "+n),this.messageQueue.completeMessages(e,n)}onNack(e,n,r){o.logAction(o.LOG_ERROR,"Protocol.onNack()","serial = "+e+"; count = "+n+"; err = "+A(r)),r||(r=new f("Unable to send message; channel not responding",50001,500)),this.messageQueue.completeMessages(e,n,r)}onceIdle(e){let n=this.messageQueue;if(n.count()===0){e();return}n.once("idle",e)}send(e){e.ackRequired&&this.messageQueue.push(e),o.shouldLog(o.LOG_MICRO)&&o.logActionNoStrip(o.LOG_MICRO,"Protocol.send()","sending msg; "+Me(e.message,this.transport.connectionManager.realtime._RealtimePresence)),e.sendAttempted=!0,this.transport.send(e.message)}getTransport(){return this.transport}getPendingMessages(){return this.messageQueue.copyAll()}clearPendingMessages(){return this.messageQueue.clear()}finish(){let e=this.transport;this.onceIdle(function(){e.disconnect()})}},Ds=bn;var Pn=class{constructor(t,e,n,r){this.previous=t,this.current=e,n&&(this.retryIn=n),r&&(this.reason=r)}},je=Pn;var de={DISCONNECTED:80003,SUSPENDED:80002,FAILED:8e4,CLOSING:80017,CLOSED:80017,UNKNOWN_CONNECTION_ERR:50002,UNKNOWN_CHANNEL_ERR:50001},hi={disconnected:()=>f.fromValues({statusCode:400,code:de.DISCONNECTED,message:"Connection to server temporarily unavailable"}),suspended:()=>f.fromValues({statusCode:400,code:de.SUSPENDED,message:"Connection to server unavailable"}),failed:()=>f.fromValues({statusCode:400,code:de.FAILED,message:"Connection failed or disconnected by server"}),closing:()=>f.fromValues({statusCode:400,code:de.CLOSING,message:"Connection closing"}),closed:()=>f.fromValues({statusCode:400,code:de.CLOSED,message:"Connection closed"}),unknownConnectionErr:()=>f.fromValues({statusCode:500,code:de.UNKNOWN_CONNECTION_ERR,message:"Internal connection error"}),unknownChannelErr:()=>f.fromValues({statusCode:500,code:de.UNKNOWN_CONNECTION_ERR,message:"Internal channel error"})};function Fs(s){return!s.statusCode||!s.code||s.statusCode>=500?!0:Object.values(de).includes(s.code)}var X=hi;var di=V({action:T.CLOSE}),fi=V({action:T.DISCONNECT}),Cn=class extends v{constructor(e,n,r,i){super();i&&(r.format=void 0,r.heartbeats=!0),this.connectionManager=e,this.auth=n,this.params=r,this.timeouts=r.options.timeouts,this.format=r.format,this.isConnected=!1,this.isFinished=!1,this.isDisposed=!1,this.maxIdleInterval=null,this.idleTimer=null,this.lastActivity=null}connect(){}close(){this.isConnected&&this.requestClose(),this.finish("closed",X.closed())}disconnect(e){this.isConnected&&this.requestDisconnect(),this.finish("disconnected",e||X.disconnected())}fail(e){this.isConnected&&this.requestDisconnect(),this.finish("failed",e||X.failed())}finish(e,n){var r;this.isFinished||(this.isFinished=!0,this.isConnected=!1,this.maxIdleInterval=null,clearTimeout((r=this.idleTimer)!=null?r:void 0),this.idleTimer=null,this.emit(e,n),this.dispose())}onProtocolMessage(e){switch(o.shouldLog(o.LOG_MICRO)&&o.logActionNoStrip(o.LOG_MICRO,"Transport.onProtocolMessage()","received on "+this.shortName+": "+Me(e,this.connectionManager.realtime._RealtimePresence)+"; connectionId = "+this.connectionManager.connectionId),this.onActivity(),e.action){case T.HEARTBEAT:o.logActionNoStrip(o.LOG_MICRO,"Transport.onProtocolMessage()",this.shortName+" heartbeat; connectionId = "+this.connectionManager.connectionId),this.emit("heartbeat",e.id);break;case T.CONNECTED:this.onConnect(e),this.emit("connected",e.error,e.connectionId,e.connectionDetails,e);break;case T.CLOSED:this.onClose(e);break;case T.DISCONNECTED:this.onDisconnect(e);break;case T.ACK:this.emit("ack",e.msgSerial,e.count);break;case T.NACK:this.emit("nack",e.msgSerial,e.count,e.error);break;case T.SYNC:this.connectionManager.onChannelMessage(e,this);break;case T.ACTIVATE:break;case T.AUTH:B(this.auth.authorize(),function(n){n&&o.logAction(o.LOG_ERROR,"Transport.onProtocolMessage()","Ably requested re-authentication, but unable to obtain a new token: "+A(n))});break;case T.ERROR:if(o.logAction(o.LOG_MINOR,"Transport.onProtocolMessage()","received error action; connectionId = "+this.connectionManager.connectionId+"; err = "+d.Config.inspect(e.error)+(e.channel?", channel: "+e.channel:"")),e.channel===void 0){this.onFatalError(e);break}this.connectionManager.onChannelMessage(e,this);break;default:this.connectionManager.onChannelMessage(e,this)}}onConnect(e){if(this.isConnected=!0,!e.connectionDetails)throw new Error("Transport.onConnect(): Connect message recieved without connectionDetails");let n=e.connectionDetails.maxIdleInterval;n&&(this.maxIdleInterval=n+this.timeouts.realtimeRequestTimeout,this.onActivity())}onDisconnect(e){let n=e&&e.error;o.logAction(o.LOG_MINOR,"Transport.onDisconnect()","err = "+A(n)),this.finish("disconnected",n)}onFatalError(e){let n=e&&e.error;o.logAction(o.LOG_MINOR,"Transport.onFatalError()","err = "+A(n)),this.finish("failed",n)}onClose(e){let n=e&&e.error;o.logAction(o.LOG_MINOR,"Transport.onClose()","err = "+A(n)),this.finish("closed",n)}requestClose(){o.logAction(o.LOG_MINOR,"Transport.requestClose()",""),this.send(di)}requestDisconnect(){o.logAction(o.LOG_MINOR,"Transport.requestDisconnect()",""),this.send(fi)}ping(e){let n={action:T.HEARTBEAT};e&&(n.id=e),this.send(V(n))}dispose(){o.logAction(o.LOG_MINOR,"Transport.dispose()",""),this.isDisposed=!0,this.off()}onActivity(){this.maxIdleInterval&&(this.lastActivity=this.connectionManager.lastActivity=Date.now(),this.setIdleTimer(this.maxIdleInterval+100))}setIdleTimer(e){this.idleTimer||(this.idleTimer=setTimeout(()=>{this.onIdleTimerExpire()},e))}onIdleTimerExpire(){if(!this.lastActivity||!this.maxIdleInterval)throw new Error("Transport.onIdleTimerExpire(): lastActivity/maxIdleInterval not set");this.idleTimer=null;let e=Date.now()-this.lastActivity,n=this.maxIdleInterval-e;if(n<=0){let r="No activity seen from realtime in "+e+"ms; assuming connection has dropped";o.logAction(o.LOG_ERROR,"Transport.onIdleTimerExpire()",r),this.disconnect(new f(r,80003,408))}else this.setIdleTimer(n+100)}static tryConnect(e,n,r,i,a){let c=new e(n,r,i),l,u=function(h){clearTimeout(l),a({event:this.event,error:h})},p=n.options.timeouts.realtimeRequestTimeout;return l=setTimeout(()=>{c.off(["preconnect","disconnected","failed"]),c.dispose(),u.call({event:"disconnected"},new f("Timeout waiting for transport to indicate itself viable",5e4,500))},p),c.on(["failed","disconnected"],u),c.on("preconnect",function(){o.logAction(o.LOG_MINOR,"Transport.tryConnect()","viable transport "+c),clearTimeout(l),c.off(["failed","disconnected"],u),a(null,c)}),c.connect(),c}static isAvailable(){throw new f("isAvailable not implemented for transport",5e4,500)}},ae=Cn;var N;(n=>(n.WebSocket="web_socket",n.Comet="comet",n.XhrPolling="xhr_polling"))(N||(N={}));var pi=typeof global!="undefined"?global:typeof window!="undefined"?window:self,Tn=()=>{var s;return typeof d.WebStorage!="undefined"&&((s=d.WebStorage)==null?void 0:s.localSupported)},Ve=()=>{var s;return typeof d.WebStorage!="undefined"&&((s=d.WebStorage)==null?void 0:s.sessionSupported)},js=function(){},In="ably-transport-preference",On="ably-connection-recovery";function mi(){var s,t;return Ve()&&((t=(s=d.WebStorage)==null?void 0:s.getSession)==null?void 0:t.call(s,On))}function gi(s){var t,e;return Ve()&&((e=(t=d.WebStorage)==null?void 0:t.setSession)==null?void 0:e.call(t,On,s))}function yi(){var s,t;return Ve()&&((t=(s=d.WebStorage)==null?void 0:s.removeSession)==null?void 0:t.call(s,On))}function Ri(s,t,e){let n;if(s.channel!==t.channel||(n=s.action)!==T.PRESENCE&&n!==T.MESSAGE||n!==t.action)return!1;let r=n===T.PRESENCE?"presence":"messages",i=s[r].concat(t[r]);return ye(i)>e||!qt(i,"clientId")||!i.every(function(c){return!c.id})?!1:(s[r]=i,!0)}function kn(s){try{return JSON.parse(s)}catch(t){return null}}var An=class{constructor(t,e,n,r){this.options=t,this.host=e,this.mode=n,this.connectionKey=r,this.format=t.useBinaryProtocol?"msgpack":"json"}getConnectParams(t){let e=t?ee(t):{},n=this.options;switch(this.mode){case"resume":e.resume=this.connectionKey;break;case"recover":{let r=kn(n.recover);r&&(e.recover=r.connectionKey);break}default:}return n.clientId!==void 0&&(e.clientId=n.clientId),n.echoMessages===!1&&(e.echo="false"),this.format!==void 0&&(e.format=this.format),this.stream!==void 0&&(e.stream=this.stream),this.heartbeats!==void 0&&(e.heartbeats=this.heartbeats),e.v=R.protocolVersion,e.agent=ot(this.options),n.transportParams!==void 0&&P(e,n.transportParams),e}toString(){let t="[mode="+this.mode;return this.host&&(t+=",host="+this.host),this.connectionKey&&(t+=",connectionKey="+this.connectionKey),this.format&&(t+=",format="+this.format),t+="]",t}},wn=class s extends v{constructor(e,n){super();this.supportedTransports={};this.disconnectedRetryCount=0;this.pendingChannelMessagesState={isProcessing:!1,queue:[]};this.realtime=e,this.initTransports(),this.options=n;let r=n.timeouts,i=r.webSocketConnectTimeout+r.realtimeRequestTimeout;if(this.states={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1,failState:"disconnected"},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:i,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:r.disconnectedRetryTimeout,failState:"disconnected"},suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:r.suspendedRetryTimeout,failState:"suspended"},closing:{state:"closing",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:r.realtimeRequestTimeout,failState:"closed"},closed:{state:"closed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"closed"},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"failed"}},this.state=this.states.initialized,this.errorReason=null,this.queuedMessages=new Tt,this.msgSerial=0,this.connectionDetails=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.connectionStateTtl=r.connectionStateTtl,this.maxIdleInterval=null,this.transports=Bt(n.transports||R.defaultTransports,this.supportedTransports),this.transportPreference=null,this.transports.includes(N.WebSocket)&&(this.webSocketTransportAvailable=!0),this.transports.includes(N.XhrPolling)?this.baseTransport=N.XhrPolling:this.transports.includes(N.Comet)&&(this.baseTransport=N.Comet),this.httpHosts=R.getHosts(n),this.wsHosts=R.getHosts(n,!0),this.activeProtocol=null,this.host=null,this.lastAutoReconnectAttempt=null,this.lastActivity=null,this.forceFallbackHost=!1,this.connectCounter=0,this.wsCheckResult=null,this.webSocketSlowTimer=null,this.webSocketGiveUpTimer=null,this.abandonedWebSocket=!1,o.logAction(o.LOG_MINOR,"Realtime.ConnectionManager()","started"),o.logAction(o.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(n.transports||R.defaultTransports)+"]"),o.logAction(o.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+this.transports+"]"),o.logAction(o.LOG_MICRO,"Realtime.ConnectionManager()","http hosts = ["+this.httpHosts+"]"),!this.transports.length){let c="no requested transports available";throw o.logAction(o.LOG_ERROR,"realtime.ConnectionManager()",c),new Error(c)}let a=d.Config.addEventListener;a&&(Ve()&&typeof n.recover=="function"&&a("beforeunload",this.persistConnection.bind(this)),n.closeOnUnload===!0&&a("beforeunload",()=>{o.logAction(o.LOG_MAJOR,"Realtime.ConnectionManager()","beforeunload event has triggered the connection to close as closeOnUnload is true"),this.requestState({state:"closing"})}),a("online",()=>{var c;this.state==this.states.disconnected||this.state==this.states.suspended?(o.logAction(o.LOG_MINOR,"ConnectionManager caught browser \u2018online\u2019 event","reattempting connection"),this.requestState({state:"connecting"})):this.state==this.states.connecting&&((c=this.pendingTransport)==null||c.off(),this.disconnectAllTransports(),this.startConnect())}),a("offline",()=>{this.state==this.states.connected&&(o.logAction(o.LOG_MINOR,"ConnectionManager caught browser \u2018offline\u2019 event","disconnecting active transport"),this.disconnectAllTransports())}))}static supportedTransports(e){let n={supportedTransports:{}};return this.initTransports(e,n),n.supportedTransports}static initTransports(e,n){let r=x(x({},d.Transports.bundledImplementations),e);[N.WebSocket,...d.Transports.order].forEach(i=>{let a=r[i];a&&a.isAvailable()&&(n.supportedTransports[i]=a)})}initTransports(){s.initTransports(this.realtime._additionalTransportImplementations,this)}createTransportParams(e,n){return new An(this.options,e,n,this.connectionKey)}getTransportParams(e){(r=>{if(this.connectionKey){r("resume");return}if(typeof this.options.recover=="string"){r("recover");return}let i=this.options.recover,a=mi();if(a&&typeof i=="function"){o.logAction(o.LOG_MINOR,"ConnectionManager.getTransportParams()","Calling clientOptions-provided recover function with last session data"),i(a,c=>{c?(this.options.recover=a.recoveryKey,r("recover")):r("clean")});return}r("clean")})(r=>{let i=this.createTransportParams(null,r);if(r==="recover"){o.logAction(o.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport recovery mode = recover; recoveryKey = "+this.options.recover);let a=kn(this.options.recover);a&&(this.msgSerial=a.msgSerial)}else o.logAction(o.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport params = "+i.toString());e(i)})}tryATransport(e,n,r){o.logAction(o.LOG_MICRO,"ConnectionManager.tryATransport()","trying "+n),this.proposedTransport=ae.tryConnect(this.supportedTransports[n],this,this.realtime.auth,e,(i,a)=>{let c=this.state;if(c==this.states.closing||c==this.states.closed||c==this.states.failed){a&&(o.logAction(o.LOG_MINOR,"ConnectionManager.tryATransport()","connection "+c.state+" while we were attempting the transport; closing "+a),a.close()),r(!0);return}if(i){o.logAction(o.LOG_MINOR,"ConnectionManager.tryATransport()","transport "+n+" "+i.event+", err: "+i.error.toString()),W.isTokenErr(i.error)&&!(this.errorReason&&W.isTokenErr(this.errorReason))?(this.errorReason=i.error,B(this.realtime.auth._forceNewToken(null,null),l=>{if(l){this.actOnErrorFromAuthorize(l);return}this.tryATransport(e,n,r)})):i.event==="failed"?(this.notifyState({state:"failed",error:i.error}),r(!0)):i.event==="disconnected"&&(Fs(i.error)?r(!1):(this.notifyState({state:this.states.connecting.failState,error:i.error}),r(!0)));return}o.logAction(o.LOG_MICRO,"ConnectionManager.tryATransport()","viable transport "+n+"; setting pending"),this.setTransportPending(a,e),r(null,a)})}setTransportPending(e,n){let r=n.mode;o.logAction(o.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+e+"; mode = "+r),this.pendingTransport=e,this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),e.once("connected",(a,c,l)=>{this.activateTransport(a,e,c,l),r==="recover"&&this.options.recover&&(delete this.options.recover,this.unpersistConnection())});let i=this;e.on(["disconnected","closed","failed"],function(a){i.deactivateTransport(e,this.event,a)}),this.emit("transport.pending",e)}activateTransport(e,n,r,i){o.logAction(o.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+n),e&&o.logAction(o.LOG_ERROR,"ConnectionManager.activateTransport()","error = "+e),r&&o.logAction(o.LOG_MICRO,"ConnectionManager.activateTransport()","connectionId =  "+r),i&&o.logAction(o.LOG_MICRO,"ConnectionManager.activateTransport()","connectionDetails =  "+JSON.stringify(i)),this.persistTransportPreference(n);let a=this.state,c=this.states.connected.state;if(o.logAction(o.LOG_MINOR,"ConnectionManager.activateTransport()","current state = "+a.state),a.state==this.states.closing.state||a.state==this.states.closed.state||a.state==this.states.failed.state)return o.logAction(o.LOG_MINOR,"ConnectionManager.activateTransport()","Disconnecting transport and abandoning"),n.disconnect(),!1;if(delete this.pendingTransport,!n.isConnected)return o.logAction(o.LOG_MINOR,"ConnectionManager.activateTransport()","Declining to activate transport "+n+" since it appears to no longer be connected"),!1;let l=this.activeProtocol;this.activeProtocol=new Ds(n),this.host=n.params.host;let u=i.connectionKey;if(u&&this.connectionKey!=u&&this.setConnection(r,i,!!e),this.onConnectionDetailsUpdate(i,n),d.Config.nextTick(()=>{n.on("connected",(p,h,g)=>{this.onConnectionDetailsUpdate(g,n),this.emit("update",new je(c,c,null,p))})}),a.state===this.states.connected.state?e&&(this.errorReason=this.realtime.connection.errorReason=e,this.emit("update",new je(c,c,null,e))):(this.notifyState({state:"connected",error:e}),this.errorReason=this.realtime.connection.errorReason=e||null),this.emit("transport.active",n),l)if(l.messageQueue.count()>0&&o.logAction(o.LOG_ERROR,"ConnectionManager.activateTransport()","Previous active protocol (for transport "+l.transport.shortName+", new one is "+n.shortName+") finishing with "+l.messageQueue.count()+" messages still pending"),l.transport===n){let p="Assumption violated: activating a transport that was also the transport for the previous active protocol; transport = "+n.shortName+"; stack = "+new Error().stack;o.logAction(o.LOG_ERROR,"ConnectionManager.activateTransport()",p)}else l.finish();return!0}deactivateTransport(e,n,r){let i=this.activeProtocol,a=i&&i.getTransport()===e,c=e===this.pendingTransport,l=this.noTransportsScheduledForActivation();if(o.logAction(o.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+e),o.logAction(o.LOG_MINOR,"ConnectionManager.deactivateTransport()","state = "+n+(a?"; was active":c?"; was pending":"")+(l?"":"; another transport is scheduled for activation")),r&&r.message&&o.logAction(o.LOG_MICRO,"ConnectionManager.deactivateTransport()","reason =  "+r.message),a&&(o.logAction(o.LOG_MICRO,"ConnectionManager.deactivateTransport()","Getting, clearing, and requeuing "+this.activeProtocol.messageQueue.count()+" pending messages"),this.queuePendingMessages(i.getPendingMessages()),i.clearPendingMessages(),this.activeProtocol=this.host=null),this.emit("transport.inactive",e),a&&l||a&&n==="failed"||n==="closed"||i===null&&c){if(n==="disconnected"&&r&&r.statusCode>500&&this.httpHosts.length>1){this.unpersistTransportPreference(),this.forceFallbackHost=!0,this.notifyState({state:n,error:r,retryImmediately:!0});return}let u=n==="failed"&&W.isTokenErr(r)?"disconnected":n;this.notifyState({state:u,error:r});return}}noTransportsScheduledForActivation(){return!this.pendingTransport||!this.pendingTransport.isConnected}setConnection(e,n,r){let i=this.connectionId;(i&&i!==e||!i&&r)&&(o.logAction(o.LOG_MINOR,"ConnectionManager.setConnection()","Resetting msgSerial"),this.msgSerial=0,this.queuedMessages.resetSendAttempted()),this.connectionId!==e&&o.logAction(o.LOG_MINOR,"ConnectionManager.setConnection()","New connectionId; reattaching any attached channels"),this.realtime.connection.id=this.connectionId=e,this.realtime.connection.key=this.connectionKey=n.connectionKey}clearConnection(){this.realtime.connection.id=this.connectionId=void 0,this.realtime.connection.key=this.connectionKey=void 0,this.msgSerial=0,this.unpersistConnection()}createRecoveryKey(){return this.connectionKey?JSON.stringify({connectionKey:this.connectionKey,msgSerial:this.msgSerial,channelSerials:this.realtime.channels.channelSerials()}):null}checkConnectionStateFreshness(){if(!this.lastActivity||!this.connectionId)return;let e=Date.now()-this.lastActivity;e>this.connectionStateTtl+this.maxIdleInterval&&(o.logAction(o.LOG_MINOR,"ConnectionManager.checkConnectionStateFreshness()","Last known activity from realtime was "+e+"ms ago; discarding connection state"),this.clearConnection(),this.states.connecting.failState="suspended")}persistConnection(){if(Ve()){let e=this.createRecoveryKey();e&&gi({recoveryKey:e,disconnectedAt:Date.now(),location:pi.location,clientId:this.realtime.auth.clientId})}}unpersistConnection(){yi()}getError(){return this.errorReason||this.getStateError()}getStateError(){var e,n;return(n=(e=X)[this.state.state])==null?void 0:n.call(e)}activeState(){return this.state.queueEvents||this.state.sendEvents}enactStateChange(e){let n="Connection state",r=e.current+(e.reason?"; reason: "+e.reason:"");e.current==="failed"?o.logAction(o.LOG_ERROR,n,r):o.logAction(o.LOG_MAJOR,n,r),o.logAction(o.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+e.current+"; reason = "+(e.reason&&e.reason.message));let i=this.state=this.states[e.current];e.reason&&(this.errorReason=e.reason,this.realtime.connection.errorReason=e.reason),(i.terminal||i.state==="suspended")&&this.clearConnection(),this.emit("connectionstate",e)}startTransitionTimer(e){o.logAction(o.LOG_MINOR,"ConnectionManager.startTransitionTimer()","transitionState: "+e.state),this.transitionTimer&&(o.logAction(o.LOG_MINOR,"ConnectionManager.startTransitionTimer()","clearing already-running timer"),clearTimeout(this.transitionTimer)),this.transitionTimer=setTimeout(()=>{this.transitionTimer&&(this.transitionTimer=null,o.logAction(o.LOG_MINOR,"ConnectionManager "+e.state+" timer expired","requesting new state: "+e.failState),this.notifyState({state:e.failState}))},e.retryDelay)}cancelTransitionTimer(){o.logAction(o.LOG_MINOR,"ConnectionManager.cancelTransitionTimer()",""),this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=null)}startSuspendTimer(){this.suspendTimer||(this.suspendTimer=setTimeout(()=>{this.suspendTimer&&(this.suspendTimer=null,o.logAction(o.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),this.states.connecting.failState="suspended",this.notifyState({state:"suspended"}))},this.connectionStateTtl))}checkSuspendTimer(e){e!=="disconnected"&&e!=="suspended"&&e!=="connecting"&&this.cancelSuspendTimer()}cancelSuspendTimer(){this.states.connecting.failState="disconnected",this.suspendTimer&&(clearTimeout(this.suspendTimer),this.suspendTimer=null)}startRetryTimer(e){this.retryTimer=setTimeout(()=>{o.logAction(o.LOG_MINOR,"ConnectionManager retry timer expired","retrying"),this.retryTimer=null,this.requestState({state:"connecting"})},e)}cancelRetryTimer(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)}startWebSocketSlowTimer(){this.webSocketSlowTimer=setTimeout(()=>{o.logAction(o.LOG_MINOR,"ConnectionManager WebSocket slow timer","checking connectivity"),this.wsCheckResult===null&&this.checkWsConnectivity().then(()=>{o.logAction(o.LOG_MINOR,"ConnectionManager WebSocket slow timer","ws connectivity check succeeded"),this.wsCheckResult=!0}).catch(()=>{o.logAction(o.LOG_MAJOR,"ConnectionManager WebSocket slow timer","ws connectivity check failed"),this.wsCheckResult=!1}),this.realtime.http.checkConnectivity&&B(this.realtime.http.checkConnectivity(),(e,n)=>{e||!n?(o.logAction(o.LOG_MAJOR,"ConnectionManager WebSocket slow timer","http connectivity check failed"),this.cancelWebSocketGiveUpTimer(),this.notifyState({state:"disconnected",error:new f("new ErrorInfo('Unable to connect (network unreachable)'",80003,404)})):o.logAction(o.LOG_MINOR,"ConnectionManager WebSocket slow timer","http connectivity check succeeded")})},this.options.timeouts.webSocketSlowTimeout)}cancelWebSocketSlowTimer(){this.webSocketSlowTimer&&(clearTimeout(this.webSocketSlowTimer),this.webSocketSlowTimer=null)}startWebSocketGiveUpTimer(e){this.webSocketGiveUpTimer=setTimeout(()=>{var n,r;this.wsCheckResult||(o.logAction(o.LOG_MINOR,"ConnectionManager WebSocket give up timer","websocket connection took more than 10s; "+(this.baseTransport?"trying base transport":"")),this.baseTransport?(this.abandonedWebSocket=!0,(n=this.proposedTransport)==null||n.dispose(),(r=this.pendingTransport)==null||r.dispose(),this.connectBase(e,++this.connectCounter)):o.logAction(o.LOG_MAJOR,"ConnectionManager WebSocket give up timer","websocket connectivity appears to be unavailable but no other transports to try"))},this.options.timeouts.webSocketConnectTimeout)}cancelWebSocketGiveUpTimer(){this.webSocketGiveUpTimer&&(clearTimeout(this.webSocketGiveUpTimer),this.webSocketGiveUpTimer=null)}notifyState(e){var l,u;let n=e.state,r=n==="disconnected"&&(this.state===this.states.connected||e.retryImmediately||this.state===this.states.connecting&&e.error&&W.isTokenErr(e.error)&&!(this.errorReason&&W.isTokenErr(this.errorReason)));if(o.logAction(o.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+n+(r?"; will retry connection immediately":"")),n==this.state.state||(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.checkSuspendTimer(e.state),(n==="suspended"||n==="connected")&&(this.disconnectedRetryCount=0),this.state.terminal))return;let i=this.states[e.state],a=i.retryDelay;i.state==="disconnected"&&(this.disconnectedRetryCount++,a=qe(i.retryDelay,this.disconnectedRetryCount));let c=new je(this.state.state,i.state,a,e.error||((u=(l=X)[i.state])==null?void 0:u.call(l)));if(r){let p=()=>{this.state===this.states.disconnected&&(this.lastAutoReconnectAttempt=Date.now(),this.requestState({state:"connecting"}))},h=this.lastAutoReconnectAttempt&&Date.now()-this.lastAutoReconnectAttempt+1;h&&h<1e3?(o.logAction(o.LOG_MICRO,"ConnectionManager.notifyState()","Last reconnect attempt was only "+h+"ms ago, waiting another "+(1e3-h)+"ms before trying again"),setTimeout(p,1e3-h)):d.Config.nextTick(p)}else(n==="disconnected"||n==="suspended")&&this.startRetryTimer(a);(n==="disconnected"&&!r||n==="suspended"||i.terminal)&&d.Config.nextTick(()=>{this.disconnectAllTransports()}),n=="connected"&&!this.activeProtocol&&o.logAction(o.LOG_ERROR,"ConnectionManager.notifyState()","Broken invariant: attempted to go into connected state, but there is no active protocol"),this.enactStateChange(c),this.state.sendEvents?this.sendQueuedMessages():this.state.queueEvents||(this.realtime.channels.propogateConnectionInterruption(n,c.reason),this.failQueuedMessages(c.reason))}requestState(e){var a,c;let n=e.state;if(o.logAction(o.LOG_MINOR,"ConnectionManager.requestState()","requested state: "+n+"; current state: "+this.state.state),n==this.state.state||(this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(n),n=="connecting"&&this.state.state=="connected")||n=="closing"&&this.state.state=="closed")return;let r=this.states[n],i=new je(this.state.state,r.state,null,e.error||((c=(a=X)[r.state])==null?void 0:c.call(a)));this.enactStateChange(i),n=="connecting"&&d.Config.nextTick(()=>{this.startConnect()}),n=="closing"&&this.closeImpl()}startConnect(){if(this.state!==this.states.connecting){o.logAction(o.LOG_MINOR,"ConnectionManager.startConnect()","Must be in connecting state to connect, but was "+this.state.state);return}let e=this.realtime.auth,n=++this.connectCounter,r=()=>{this.checkConnectionStateFreshness(),this.getTransportParams(i=>{if(i.mode==="recover"&&i.options.recover){let a=kn(i.options.recover);a&&this.realtime.channels.recoverChannels(a.channelSerials)}n===this.connectCounter&&this.connectImpl(i,n)})};if(o.logAction(o.LOG_MINOR,"ConnectionManager.startConnect()","starting connection"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),e.method==="basic")r();else{let i=a=>{n===this.connectCounter&&(a?this.actOnErrorFromAuthorize(a):r())};this.errorReason&&W.isTokenErr(this.errorReason)?B(e._forceNewToken(null,null),i):B(e._ensureValidAuthCredentials(!1),i)}}connectImpl(e,n){let r=this.state.state;if(r!==this.states.connecting.state){o.logAction(o.LOG_MINOR,"ConnectionManager.connectImpl()","Must be in connecting state to connect, but was "+r);return}let i=this.getTransportPreference();i&&i===this.baseTransport&&this.webSocketTransportAvailable&&this.checkWsConnectivity().then(()=>{this.wsCheckResult=!0,this.abandonedWebSocket=!1,this.unpersistTransportPreference(),this.state===this.states.connecting&&(o.logAction(o.LOG_MINOR,"ConnectionManager.connectImpl():","web socket connectivity available, cancelling connection attempt with "+this.baseTransport),this.disconnectAllTransports(),this.connectWs(e,++this.connectCounter))}).catch(js),i&&i===this.baseTransport||this.baseTransport&&!this.webSocketTransportAvailable?this.connectBase(e,n):this.connectWs(e,n)}connectWs(e,n){o.logAction(o.LOG_DEBUG,"ConnectionManager.connectWs()"),this.startWebSocketSlowTimer(),this.startWebSocketGiveUpTimer(e),this.tryTransportWithFallbacks("web_socket",e,!0,n,()=>this.wsCheckResult!==!1&&!this.abandonedWebSocket)}connectBase(e,n){o.logAction(o.LOG_DEBUG,"ConnectionManager.connectBase()"),this.baseTransport?this.tryTransportWithFallbacks(this.baseTransport,e,!1,n,()=>!0):this.notifyState({state:"disconnected",error:new f("No transports left to try",8e4,404)})}tryTransportWithFallbacks(e,n,r,i,a){o.logAction(o.LOG_DEBUG,"ConnectionManager.tryTransportWithFallbacks()",e);let c=g=>{this.notifyState({state:this.states.connecting.failState,error:g})},l=r?this.wsHosts.slice():this.httpHosts.slice(),u=(g,m)=>{if(i===this.connectCounter){if(!a()){m&&m.dispose();return}!m&&!g&&h()}},p=l.shift();if(!p){c(new f("Unable to connect (no available host)",80003,404));return}n.host=p;let h=()=>{if(!l.length){c(new f("Unable to connect (and no more fallback hosts to try)",80003,404));return}if(!this.realtime.http.checkConnectivity){c(new S("Internal error: Http.checkConnectivity not set",null,500));return}B(this.realtime.http.checkConnectivity(),(g,m)=>{if(i===this.connectCounter&&a()){if(g){c(g);return}if(!m){c(new f("Unable to connect (network unreachable)",80003,404));return}n.host=rt(l),this.tryATransport(n,e,u)}})};if(this.forceFallbackHost&&l.length){this.forceFallbackHost=!1,h();return}this.tryATransport(n,e,u)}closeImpl(){o.logAction(o.LOG_MINOR,"ConnectionManager.closeImpl()","closing connection"),this.cancelSuspendTimer(),this.startTransitionTimer(this.states.closing),this.pendingTransport&&(o.logAction(o.LOG_MICRO,"ConnectionManager.closeImpl()","Closing pending transport: "+this.pendingTransport),this.pendingTransport.close()),this.activeProtocol&&(o.logAction(o.LOG_MICRO,"ConnectionManager.closeImpl()","Closing active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().close()),this.notifyState({state:"closed"})}onAuthUpdated(e,n){var r;switch(this.state.state){case"connected":{o.logAction(o.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Sending AUTH message on active transport");let i=(r=this.activeProtocol)==null?void 0:r.getTransport();i&&i.onAuthUpdated&&i.onAuthUpdated(e);let a=V({action:T.AUTH,auth:{accessToken:e.token}});this.send(a);let c=()=>{this.off(l),n(null,e)},l=u=>{u.current==="failed"&&(this.off(c),this.off(l),n(u.reason||this.getStateError()))};this.once("connectiondetails",c),this.on("connectionstate",l);break}case"connecting":o.logAction(o.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Aborting current connection attempts in order to start again with the new auth details"),this.disconnectAllTransports();default:{o.logAction(o.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Connection state is "+this.state.state+"; waiting until either connected or failed");let i=a=>{switch(a.current){case"connected":this.off(i),n(null,e);break;case"failed":case"closed":case"suspended":this.off(i),n(a.reason||this.getStateError());break;default:break}};this.on("connectionstate",i),this.state.state==="connecting"?this.startConnect():this.requestState({state:"connecting"})}}}disconnectAllTransports(){o.logAction(o.LOG_MINOR,"ConnectionManager.disconnectAllTransports()","Disconnecting all transports"),this.connectCounter++,this.pendingTransport&&(o.logAction(o.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting pending transport: "+this.pendingTransport),this.pendingTransport.disconnect()),delete this.pendingTransport,this.proposedTransport&&(o.logAction(o.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting proposed transport: "+this.pendingTransport),this.proposedTransport.disconnect()),delete this.pendingTransport,this.activeProtocol&&(o.logAction(o.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().disconnect())}send(e,n,r){r=r||js;let i=this.state;if(i.sendEvents){o.logAction(o.LOG_MICRO,"ConnectionManager.send()","sending event"),this.sendImpl(new Fe(e,r));return}if(!(n&&i.queueEvents)){let c="rejecting event, queueEvent was "+n+", state was "+i.state;o.logAction(o.LOG_MICRO,"ConnectionManager.send()",c),r(this.errorReason||new f(c,9e4,400));return}o.shouldLog(o.LOG_MICRO)&&o.logAction(o.LOG_MICRO,"ConnectionManager.send()","queueing msg; "+Me(e,this.realtime._RealtimePresence)),this.queue(e,r)}sendImpl(e){let n=e.message;e.ackRequired&&!e.sendAttempted&&(n.msgSerial=this.msgSerial++);try{this.activeProtocol.send(e)}catch(r){o.logAction(o.LOG_ERROR,"ConnectionManager.sendImpl()","Unexpected exception in transport.send(): "+r.stack)}}queue(e,n){o.logAction(o.LOG_MICRO,"ConnectionManager.queue()","queueing event");let r=this.queuedMessages.last(),i=this.options.maxMessageSize;r&&!r.sendAttempted&&Ri(r.message,e,i)?(r.merged||(r.callback=Pe.create([r.callback]),r.merged=!0),r.callback.push(n)):this.queuedMessages.push(new Fe(e,n))}sendQueuedMessages(){o.logAction(o.LOG_MICRO,"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.count()+" queued messages");let e;for(;e=this.queuedMessages.shift();)this.sendImpl(e)}queuePendingMessages(e){e&&e.length&&(o.logAction(o.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+e.length+" pending messages"),this.queuedMessages.prepend(e))}failQueuedMessages(e){let n=this.queuedMessages.count();n>0&&(o.logAction(o.LOG_ERROR,"ConnectionManager.failQueuedMessages()","failing "+n+" queued messages, err = "+A(e)),this.queuedMessages.completeAllMessages(e))}onChannelMessage(e,n){this.pendingChannelMessagesState.queue.push({message:e,transport:n}),this.pendingChannelMessagesState.isProcessing||this.processNextPendingChannelMessage()}processNextPendingChannelMessage(){if(this.pendingChannelMessagesState.queue.length>0){this.pendingChannelMessagesState.isProcessing=!0;let e=this.pendingChannelMessagesState.queue.shift();this.processChannelMessage(e.message).catch(n=>{o.logAction(o.LOG_ERROR,"ConnectionManager.processNextPendingChannelMessage() received error ",n)}).finally(()=>{this.pendingChannelMessagesState.isProcessing=!1,this.processNextPendingChannelMessage()})}}async processChannelMessage(e){await this.realtime.channels.processChannelMessage(e)}ping(e,n){if(e){o.logAction(o.LOG_MINOR,"ConnectionManager.ping()","transport = "+e);let c=function(){e.off("heartbeat",p),n(new f("Timeout waiting for heartbeat response",5e4,500))},l=Date.now(),u=_e(),p=function(g){if(g===u){e.off("heartbeat",p),clearTimeout(h);let m=Date.now()-l;n(null,m)}},h=setTimeout(c,this.options.timeouts.realtimeRequestTimeout);e.on("heartbeat",p),e.ping(u);return}if(this.state.state!=="connected"){n(new f("Unable to ping service; not connected",4e4,400));return}let r=!1,i=(c,l)=>{this.off("transport.active",a),r||(r=!0,n(c,l))},a=()=>{r||(r=!0,d.Config.nextTick(()=>{this.ping(null,n)}))};this.on("transport.active",a),this.ping(this.activeProtocol.getTransport(),i)}abort(e){this.activeProtocol.getTransport().fail(e)}getTransportPreference(){var e,n;return this.transportPreference||Tn()&&((n=(e=d.WebStorage)==null?void 0:e.get)==null?void 0:n.call(e,In))}persistTransportPreference(e){var n,r;this.transportPreference=e.shortName,Tn()&&((r=(n=d.WebStorage)==null?void 0:n.set)==null||r.call(n,In,e.shortName))}unpersistTransportPreference(){var e,n;this.transportPreference=null,Tn()&&((n=(e=d.WebStorage)==null?void 0:e.remove)==null||n.call(e,In))}actOnErrorFromAuthorize(e){if(e.code===40171)this.notifyState({state:"failed",error:e});else if(e.code===40102)this.notifyState({state:"failed",error:e});else if(e.statusCode===le.Forbidden){let n="Client configured authentication provider returned 403; failing the connection";o.logAction(o.LOG_ERROR,"ConnectionManager.actOnErrorFromAuthorize()",n),this.notifyState({state:"failed",error:new f(n,80019,403,e)})}else{let n="Client configured authentication provider request failed";o.logAction(o.LOG_MINOR,"ConnectionManager.actOnErrorFromAuthorize",n),this.notifyState({state:this.state.failState,error:new f(n,80019,401,e)})}}onConnectionDetailsUpdate(e,n){if(!e)return;this.connectionDetails=e,e.maxMessageSize&&(this.options.maxMessageSize=e.maxMessageSize);let r=e.clientId;if(r){let a=this.realtime.auth._uncheckedSetClientId(r);if(a){o.logAction(o.LOG_ERROR,"ConnectionManager.onConnectionDetailsUpdate()",a.message),n.fail(a);return}}let i=e.connectionStateTtl;i&&(this.connectionStateTtl=i),this.maxIdleInterval=e.maxIdleInterval,this.emit("connectiondetails",e)}checkWsConnectivity(){let e=new d.Config.WebSocket(R.wsConnectivityUrl);return new Promise((n,r)=>{let i=!1;e.onopen=()=>{i||(i=!0,n(),e.close())},e.onclose=e.onerror=()=>{i||(i=!0,r())}})}},It=wn;var Mn=class extends v{constructor(e,n){super();this.whenState=e=>v.prototype.whenState.call(this,e,this.state);this.ably=e,this.connectionManager=new It(e,n),this.state=this.connectionManager.state.state,this.key=void 0,this.id=void 0,this.errorReason=null,this.connectionManager.on("connectionstate",r=>{let i=this.state=r.current;d.Config.nextTick(()=>{this.emit(i,r)})}),this.connectionManager.on("update",r=>{d.Config.nextTick(()=>{this.emit("update",r)})})}connect(){o.logAction(o.LOG_MINOR,"Connection.connect()",""),this.connectionManager.requestState({state:"connecting"})}async ping(){return o.logAction(o.LOG_MINOR,"Connection.ping()",""),new Promise((e,n)=>{this.connectionManager.ping(null,(r,i)=>r?n(r):e(i))})}close(){o.logAction(o.LOG_MINOR,"Connection.close()","connectionKey = "+this.key),this.connectionManager.requestState({state:"closing"})}get recoveryKey(){return o.deprecationWarning("The `Connection.recoveryKey` attribute has been replaced by the `Connection.createRecoveryKey()` method. Replace your usage of `recoveryKey` with the return value of `createRecoveryKey()`. `recoveryKey` will be removed in a future version."),this.createRecoveryKey()}createRecoveryKey(){return this.connectionManager.createRecoveryKey()}},Vs=Mn;var Sn=class{constructor(t,e,n,r,i){this.previous=t,this.current=e,e==="attached"&&(this.resumed=n,this.hasBacklog=r),i&&(this.reason=i)}},We=Sn;var Ws=function(){};function bi(s){if(s&&"params"in s&&!te(s.params))return new f("options.params must be an object",4e4,400);if(s&&"modes"in s){if(!Array.isArray(s.modes))return new f("options.modes must be an array",4e4,400);for(let t=0;t<s.modes.length;t++){let e=s.modes[t];if(!e||typeof e!="string"||!yn.includes(String.prototype.toUpperCase.call(e)))return new f("Invalid channel mode: "+e,4e4,400)}}}var En=class s extends v{constructor(e,n,r){var i;super();this.retryCount=0;this.history=async function(e){o.logAction(o.LOG_MICRO,"RealtimeChannel.history()","channel = "+this.name);let n=this.client.rest.channelMixin;if(e&&e.untilAttach){if(this.state!=="attached")throw new f("option untilAttach requires the channel to be attached",4e4,400);if(!this.properties.attachSerial)throw new f("untilAttach was specified and channel is attached, but attachSerial is not defined",4e4,400);delete e.untilAttach,e.from_serial=this.properties.attachSerial}return n.history(this,e)};this.whenState=e=>v.prototype.whenState.call(this,e,this.state);o.logAction(o.LOG_MINOR,"RealtimeChannel()","started; name = "+n),this.name=n,this.channelOptions=be((i=e._Crypto)!=null?i:null,r),this.client=e,this._presence=e._RealtimePresence?new e._RealtimePresence.RealtimePresence(this):null,this.connectionManager=e.connection.connectionManager,this.state="initialized",this.subscriptions=new v,this.syncChannelSerial=void 0,this.properties={attachSerial:void 0,channelSerial:void 0},this.setOptions(r),this.errorReason=null,this._requestedFlags=null,this._mode=null,this._attachResume=!1,this._decodingContext={channelOptions:this.channelOptions,plugins:e.options.plugins||{},baseEncodedPreviousPayload:void 0},this._lastPayload={messageId:null,protocolMessageChannelSerial:null,decodeFailureRecoveryInProgress:null},this._allChannelChanges=new v}get presence(){return this._presence||D("RealtimePresence"),this._presence}invalidStateError(){return new f("Channel operation failed as channel state is "+this.state,90001,400,this.errorReason||void 0)}static processListenerArgs(e){return e=Array.prototype.slice.call(e),typeof e[0]=="function"&&e.unshift(null),e}async setOptions(e){var i;let n=this.channelOptions,r=bi(e);if(r)throw r;if(this.channelOptions=be((i=this.client._Crypto)!=null?i:null,e),this._decodingContext&&(this._decodingContext.channelOptions=this.channelOptions),this._shouldReattachToSetOptions(e,n))return this.attachImpl(),new Promise((a,c)=>{this._allChannelChanges.once(["attached","update","detached","failed"],function(l){switch(this.event){case"update":case"attached":a();break;default:c(l.reason)}})})}_shouldReattachToSetOptions(e,n){if(!(this.state==="attached"||this.state==="attaching"))return!1;if(e!=null&&e.params){let r=zs(e.params),i=zs(n.params);if(Object.keys(r).length!==Object.keys(i).length||!jt(i,r))return!0}return!!(e!=null&&e.modes&&(!n.modes||!Wt(e.modes,n.modes)))}async publish(...e){let n=e[0],r=e.length;if(!this.connectionManager.activeState())throw this.connectionManager.getError();if(r==1)if(te(n))n=[Z(n)];else if(Array.isArray(n))n=Te(n);else throw new f("The single-argument form of publish() expects a message object or an array of message objects",40013,400);else n=[Z({name:e[0],data:e[1]})];let i=this.client.options.maxMessageSize;await ft(n,this.channelOptions);let a=ye(n);if(a>i)throw new f("Maximum size of messages that can be published at once exceeded ( was "+a+" bytes; limit is "+i+" bytes)",40009,400);return new Promise((c,l)=>{this._publish(n,u=>u?l(u):c())})}_publish(e,n){o.logAction(o.LOG_MICRO,"RealtimeChannel.publish()","message count = "+e.length);let r=this.state;switch(r){case"failed":case"suspended":n(f.fromValues(this.invalidStateError()));break;default:{o.logAction(o.LOG_MICRO,"RealtimeChannel.publish()","sending message; channel state is "+r);let i=new Ct;i.action=T.MESSAGE,i.channel=this.name,i.messages=e,this.sendMessage(i,n);break}}}onEvent(e){o.logAction(o.LOG_MICRO,"RealtimeChannel.onEvent()","received message");let n=this.subscriptions;for(let r=0;r<e.length;r++){let i=e[r];n.emit(i.name,i)}}async attach(){return this.state==="attached"?null:new Promise((e,n)=>{this._attach(!1,null,(r,i)=>r?n(r):e(i))})}_attach(e,n,r){r||(r=function(a){a&&o.logAction(o.LOG_ERROR,"RealtimeChannel._attach()","Channel attach failed: "+a.toString())});let i=this.connectionManager;if(!i.activeState()){r(i.getError());return}(this.state!=="attaching"||e)&&this.requestState("attaching",n),this.once(function(a){switch(this.event){case"attached":r==null||r(null,a);break;case"detached":case"suspended":case"failed":r==null||r(a.reason||i.getError()||new f("Unable to attach; reason unknown; state = "+this.event,9e4,500));break;case"detaching":r==null||r(new f("Attach request superseded by a subsequent detach request",9e4,409));break}})}attachImpl(){o.logAction(o.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message");let e=V({action:T.ATTACH,channel:this.name,params:this.channelOptions.params,channelSerial:this.properties.channelSerial});this._requestedFlags?e.encodeModesToFlags(this._requestedFlags):this.channelOptions.modes&&e.encodeModesToFlags(Ft(this.channelOptions.modes)),this._attachResume&&e.setFlag("ATTACH_RESUME"),this._lastPayload.decodeFailureRecoveryInProgress&&(e.channelSerial=this._lastPayload.protocolMessageChannelSerial),this.sendMessage(e,Ws)}async detach(){let e=this.connectionManager;if(!e.activeState())throw e.getError();switch(this.state){case"suspended":this.notifyState("detached");return;case"detached":return;case"failed":throw new f("Unable to detach; channel state = failed",90001,400);default:this.requestState("detaching");case"detaching":return new Promise((n,r)=>{this.once(function(i){switch(this.event){case"detached":n();break;case"attached":case"suspended":case"failed":r(i.reason||e.getError()||new f("Unable to detach; reason unknown; state = "+this.event,9e4,500));break;case"attaching":r(new f("Detach request superseded by a subsequent attach request",9e4,409));break}})})}}detachImpl(e){o.logAction(o.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message");let n=V({action:T.DETACH,channel:this.name});this.sendMessage(n,e||Ws)}async subscribe(...e){let[n,r]=s.processListenerArgs(e);if(this.state==="failed")throw f.fromValues(this.invalidStateError());return n&&typeof n=="object"&&!Array.isArray(n)?this.client._FilteredSubscriptions.subscribeFilter(this,n,r):this.subscriptions.on(n,r),this.attach()}unsubscribe(...e){var i;let[n,r]=s.processListenerArgs(e);if(typeof n=="object"&&!r||(i=this.filteredSubscriptions)!=null&&i.has(r)){this.client._FilteredSubscriptions.getAndDeleteFilteredSubscriptions(this,n,r).forEach(a=>this.subscriptions.off(a));return}this.subscriptions.off(n,r)}sync(){switch(this.state){case"initialized":case"detaching":case"detached":throw new S("Unable to sync to channel; not attached",4e4);default:}let e=this.connectionManager;if(!e.activeState())throw e.getError();let n=V({action:T.SYNC,channel:this.name});this.syncChannelSerial&&(n.channelSerial=this.syncChannelSerial),e.send(n)}sendMessage(e,n){this.connectionManager.send(e,this.client.options.queueMessages,n)}sendPresence(e,n){let r=V({action:T.PRESENCE,channel:this.name,presence:Array.isArray(e)?this.client._RealtimePresence.presenceMessagesFromValuesArray(e):[this.client._RealtimePresence.presenceMessageFromValues(e)]});this.sendMessage(r,n)}async processMessage(e){(e.action===T.ATTACHED||e.action===T.MESSAGE||e.action===T.PRESENCE)&&this.setChannelSerial(e.channelSerial);let n,r=!1;switch(e.action){case T.ATTACHED:{this.properties.attachSerial=e.channelSerial,this._mode=e.getMode(),this.params=e.params||{};let i=e.decodeModesFromFlags();this.modes=i&&Le(i)||void 0;let a=e.hasFlag("RESUMED"),c=e.hasFlag("HAS_PRESENCE"),l=e.hasFlag("HAS_BACKLOG");if(this.state==="attached"){a||this._presence&&this._presence.onAttached(c);let u=new We(this.state,this.state,a,l,e.error);this._allChannelChanges.emit("update",u),(!a||this.channelOptions.updateOnAttached)&&this.emit("update",u)}else this.state==="detaching"?this.checkPendingState():this.notifyState("attached",e.error,a,c,l);break}case T.DETACHED:{let i=e.error?f.fromValues(e.error):new f("Channel detached",90001,404);this.state==="detaching"?this.notifyState("detached",i):this.state==="attaching"?this.notifyState("suspended",i):this.requestState("attaching",i);break}case T.SYNC:if(r=!0,n=this.syncChannelSerial=e.channelSerial,!e.presence)break;case T.PRESENCE:{let i=e.presence;if(!i)break;let{id:a,connectionId:c,timestamp:l}=e,u=this.channelOptions,p;for(let h=0;h<i.length;h++)try{p=i[h],await pt(p,u),p.connectionId||(p.connectionId=c),p.timestamp||(p.timestamp=l),p.id||(p.id=a+":"+h)}catch(g){o.logAction(o.LOG_ERROR,"RealtimeChannel.processMessage()",g.toString())}this._presence&&this._presence.setPresence(i,r,n);break}case T.MESSAGE:{if(this.state!=="attached"){o.logAction(o.LOG_MAJOR,"RealtimeChannel.processMessage()",'Message "'+e.id+'" skipped as this channel "'+this.name+'" state is not "attached" (state is "'+this.state+'").');return}let i=e.messages,a=i[0],c=i[i.length-1],l=e.id,u=e.connectionId,p=e.timestamp;if(a.extras&&a.extras.delta&&a.extras.delta.from!==this._lastPayload.messageId){let h='Delta message decode failure - previous message not available for message "'+e.id+'" on this channel "'+this.name+'".';o.logAction(o.LOG_ERROR,"RealtimeChannel.processMessage()",h),this._startDecodeFailureRecovery(new f(h,40018,400));break}for(let h=0;h<i.length;h++){let g=i[h];try{await he(g,this._decodingContext)}catch(m){switch(o.logAction(o.LOG_ERROR,"RealtimeChannel.processMessage()",m.toString()),m.code){case 40018:this._startDecodeFailureRecovery(m);return;case 40019:case 40021:this.notifyState("failed",m);return}}g.connectionId||(g.connectionId=u),g.timestamp||(g.timestamp=p),g.id||(g.id=l+":"+h)}this._lastPayload.messageId=c.id,this._lastPayload.protocolMessageChannelSerial=e.channelSerial,this.onEvent(i);break}case T.ERROR:{let i=e.error;i&&i.code==80016?this.checkPendingState():this.notifyState("failed",f.fromValues(i));break}default:o.logAction(o.LOG_ERROR,"RealtimeChannel.processMessage()","Fatal protocol error: unrecognised action ("+e.action+")"),this.connectionManager.abort(X.unknownChannelErr())}}_startDecodeFailureRecovery(e){this._lastPayload.decodeFailureRecoveryInProgress||(o.logAction(o.LOG_MAJOR,"RealtimeChannel.processMessage()","Starting decode failure recovery process."),this._lastPayload.decodeFailureRecoveryInProgress=!0,this._attach(!0,e,()=>{this._lastPayload.decodeFailureRecoveryInProgress=!1}))}onAttached(){o.logAction(o.LOG_MINOR,"RealtimeChannel.onAttached","activating channel; name = "+this.name)}notifyState(e,n,r,i,a){if(o.logAction(o.LOG_MICRO,"RealtimeChannel.notifyState","name = "+this.name+", current state = "+this.state+", notifying state "+e),this.clearStateTimer(),["detached","suspended","failed"].includes(e)&&(this.properties.channelSerial=null),e===this.state)return;this._presence&&this._presence.actOnChannelState(e,i,n),e==="suspended"&&this.connectionManager.state.sendEvents?this.startRetryTimer():this.cancelRetryTimer(),n&&(this.errorReason=n);let c=new We(this.state,e,r,a,n),l='Channel state for channel "'+this.name+'"',u=e+(n?"; reason: "+n:"");e==="failed"?o.logAction(o.LOG_ERROR,l,u):o.logAction(o.LOG_MAJOR,l,u),e!=="attaching"&&e!=="suspended"&&(this.retryCount=0),e==="attached"&&this.onAttached(),e==="attached"?this._attachResume=!0:(e==="detaching"||e==="failed")&&(this._attachResume=!1),this.state=e,this._allChannelChanges.emit(e,c),this.emit(e,c)}requestState(e,n){o.logAction(o.LOG_MINOR,"RealtimeChannel.requestState","name = "+this.name+", state = "+e),this.notifyState(e,n),this.checkPendingState()}checkPendingState(){if(!this.connectionManager.state.sendEvents){o.logAction(o.LOG_MINOR,"RealtimeChannel.checkPendingState","sendEvents is false; state is "+this.connectionManager.state.state);return}switch(o.logAction(o.LOG_MINOR,"RealtimeChannel.checkPendingState","name = "+this.name+", state = "+this.state),this.state){case"attaching":this.startStateTimerIfNotRunning(),this.attachImpl();break;case"detaching":this.startStateTimerIfNotRunning(),this.detachImpl();break;case"attached":this.sync();break;default:break}}timeoutPendingState(){switch(this.state){case"attaching":{let e=new f("Channel attach timed out",90007,408);this.notifyState("suspended",e);break}case"detaching":{let e=new f("Channel detach timed out",90007,408);this.notifyState("attached",e);break}default:this.checkPendingState();break}}startStateTimerIfNotRunning(){this.stateTimer||(this.stateTimer=setTimeout(()=>{o.logAction(o.LOG_MINOR,"RealtimeChannel.startStateTimerIfNotRunning","timer expired"),this.stateTimer=null,this.timeoutPendingState()},this.client.options.timeouts.realtimeRequestTimeout))}clearStateTimer(){let e=this.stateTimer;e&&(clearTimeout(e),this.stateTimer=null)}startRetryTimer(){if(this.retryTimer)return;this.retryCount++;let e=qe(this.client.options.timeouts.channelRetryTimeout,this.retryCount);this.retryTimer=setTimeout(()=>{this.state==="suspended"&&this.connectionManager.state.sendEvents&&(this.retryTimer=null,o.logAction(o.LOG_MINOR,"RealtimeChannel retry timer expired","attempting a new attach"),this.requestState("attaching"))},e)}cancelRetryTimer(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)}getReleaseErr(){let e=this.state;return e==="initialized"||e==="detached"||e==="failed"?null:new f("Can only release a channel in a state where there is no possibility of further updates from the server being received (initialized, detached, or failed); was "+e,90001,400)}setChannelSerial(e){o.logAction(o.LOG_MICRO,"RealtimeChannel.setChannelSerial()","Updating channel serial; serial = "+e+"; previous = "+this.properties.channelSerial),e&&(this.properties.channelSerial=e)}async status(){return this.client.rest.channelMixin.status(this)}};function zs(s){let n=s||{},{agent:t}=n;return ss(n,["agent"])}var ze=En;var vn=class s extends lt{constructor(e){var n,r;super(R.objectifyOptions(e,!1,"BaseRealtime"));o.logAction(o.LOG_MINOR,"Realtime()",""),this._additionalTransportImplementations=s.transportImplementationsFromPlugins(this.options.plugins),this._RealtimePresence=(r=(n=this.options.plugins)==null?void 0:n.RealtimePresence)!=null?r:null,this.connection=new Vs(this,this.options),this._channels=new xn(this),this.options.autoConnect!==!1&&this.connect()}static transportImplementationsFromPlugins(e){let n={};return e!=null&&e.WebSocketTransport&&(n[N.WebSocket]=e.WebSocketTransport),e!=null&&e.XHRPolling&&(n[N.XhrPolling]=e.XHRPolling),n}get channels(){return this._channels}connect(){o.logAction(o.LOG_MINOR,"Realtime.connect()",""),this.connection.connect()}close(){o.logAction(o.LOG_MINOR,"Realtime.close()",""),this.connection.close()}},xn=class extends v{constructor(e){super();this.realtime=e,this.all=Object.create(null),e.connection.connectionManager.on("transport.active",()=>{this.onTransportActive()})}channelSerials(){let e={};for(let n of ce(this.all,!0)){let r=this.all[n];r.properties.channelSerial&&(e[n]=r.properties.channelSerial)}return e}recoverChannels(e){for(let n of ce(e,!0)){let r=this.get(n);r.properties.channelSerial=e[n]}}async processChannelMessage(e){let n=e.channel;if(n===void 0){o.logAction(o.LOG_ERROR,"Channels.processChannelMessage()","received event unspecified channel, action = "+e.action);return}let r=this.all[n];if(!r){o.logAction(o.LOG_ERROR,"Channels.processChannelMessage()","received event for non-existent channel: "+n);return}await r.processMessage(e)}onTransportActive(){for(let e in this.all){let n=this.all[e];n.state==="attaching"||n.state==="detaching"?n.checkPendingState():n.state==="suspended"?n._attach(!1,null):n.state==="attached"&&n.requestState("attaching")}}propogateConnectionInterruption(e,n){let r={closing:"detached",closed:"detached",failed:"failed",suspended:"suspended"},i=["attaching","attached","detaching","suspended"],a=r[e];for(let c in this.all){let l=this.all[c];i.includes(l.state)&&l.notifyState(a,n)}}get(e,n){e=String(e);let r=this.all[e];if(!r)r=this.all[e]=new ze(this.realtime,e,n);else if(n){if(r._shouldReattachToSetOptions(n,r.channelOptions))throw new f("Channels.get() cannot be used to set channel options that would cause the channel to reattach. Please, use RealtimeChannel.setOptions() instead.",4e4,400);r.setOptions(n)}return r}getDerived(e,n,r){if(n.filter){let i=Re(n.filter),a=Vt(e);e=`[filter=${i}${a.qualifierParam}]${a.channelName}`}return this.get(e,r)}release(e){e=String(e);let n=this.all[e];if(!n)return;let r=n.getReleaseErr();if(r)throw r;delete this.all[e]}},Ks=vn;function Pi(s){return s.channel.client.auth.clientId}function Un(s){let t=s.channel.client,e=t.auth.clientId;return(!e||e==="*")&&t.connection.state==="connected"}function Ci(s,t,e){switch(s.state){case"attached":case"suspended":e();break;case"initialized":case"detached":case"detaching":case"attaching":B(s.attach(),function(n){n?t(n):e()});break;default:t(f.fromValues(s.invalidStateError()))}}function Js(s,t){if(s.isSynthesized()||t.isSynthesized())return s.timestamp>=t.timestamp;let e=s.parseId(),n=t.parseId();return e.msgSerial===n.msgSerial?e.index>n.index:e.msgSerial>n.msgSerial}var Bn=class extends v{constructor(e){super();this.channel=e,this.syncComplete=!1,this.members=new kt(this,n=>n.clientId+":"+n.connectionId),this._myMembers=new kt(this,n=>n.clientId),this.subscriptions=new v,this.pendingPresence=[]}async enter(e){if(Un(this))throw new f("clientId must be specified to enter a presence channel",40012,400);return this._enterOrUpdateClient(void 0,void 0,e,"enter")}async update(e){if(Un(this))throw new f("clientId must be specified to update presence data",40012,400);return this._enterOrUpdateClient(void 0,void 0,e,"update")}async enterClient(e,n){return this._enterOrUpdateClient(void 0,e,n,"enter")}async updateClient(e,n){return this._enterOrUpdateClient(void 0,e,n,"update")}async _enterOrUpdateClient(e,n,r,i){let a=this.channel;if(!a.connectionManager.activeState())throw a.connectionManager.getError();o.logAction(o.LOG_MICRO,"RealtimePresence."+i+"Client()","channel = "+a.name+", id = "+e+", client = "+(n||"(implicit) "+Pi(this)));let c=un(r);switch(c.action=i,e&&(c.id=e),n&&(c.clientId=n),await Ce(c,a.channelOptions),a.state){case"attached":return new Promise((l,u)=>{a.sendPresence(c,p=>p?u(p):l())});case"initialized":case"detached":a.attach();case"attaching":return new Promise((l,u)=>{this.pendingPresence.push({presence:c,callback:p=>p?u(p):l()})});default:{let l=new S("Unable to "+i+" presence channel while in "+a.state+" state",90001);throw l.code=90001,l}}}async leave(e){if(Un(this))throw new f("clientId must have been specified to enter or leave a presence channel",40012,400);return this.leaveClient(void 0,e)}async leaveClient(e,n){let r=this.channel;if(!r.connectionManager.activeState())throw r.connectionManager.getError();o.logAction(o.LOG_MICRO,"RealtimePresence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+e);let i=un(n);return i.action="leave",e&&(i.clientId=e),new Promise((a,c)=>{switch(r.state){case"attached":r.sendPresence(i,l=>l?c(l):a());break;case"attaching":this.pendingPresence.push({presence:i,callback:l=>l?c(l):a()});break;case"initialized":case"failed":{let l=new S("Unable to leave presence channel (incompatible state)",90001);c(l);break}default:c(r.invalidStateError())}})}async get(e){let n=!e||("waitForSync"in e?e.waitForSync:!0);return new Promise((r,i)=>{function a(c){r(e?c.list(e):c.values())}if(this.channel.state==="suspended"){n?i(f.fromValues({statusCode:400,code:91005,message:"Presence state is out of sync due to channel being in the SUSPENDED state"})):a(this.members);return}Ci(this.channel,c=>i(c),()=>{let c=this.members;n?c.waitSync(function(){a(c)}):a(c)})})}async history(e){o.logAction(o.LOG_MICRO,"RealtimePresence.history()","channel = "+this.name);let n=this.channel.client.rest.presenceMixin;if(e&&e.untilAttach)if(this.channel.state==="attached")delete e.untilAttach,e.from_serial=this.channel.properties.attachSerial;else throw new f("option untilAttach requires the channel to be attached, was: "+this.channel.state,4e4,400);return n.history(this,e)}setPresence(e,n,r){o.logAction(o.LOG_MICRO,"RealtimePresence.setPresence()","received presence for "+e.length+" participants; syncChannelSerial = "+r);let i,a,c=this.members,l=this._myMembers,u=[],p=this.channel.connectionManager.connectionId;n&&(this.members.startSync(),r&&(a=r.match(/^[\w-]+:(.*)$/))&&(i=a[1]));for(let h=0;h<e.length;h++){let g=j(e[h]);switch(g.action){case"leave":c.remove(g)&&u.push(g),g.connectionId===p&&!g.isSynthesized()&&l.remove(g);break;case"enter":case"present":case"update":c.put(g)&&u.push(g),g.connectionId===p&&l.put(g);break}}n&&!i&&(c.endSync(),this.channel.syncChannelSerial=null);for(let h=0;h<u.length;h++){let g=u[h];this.subscriptions.emit(g.action,g)}}onAttached(e){o.logAction(o.LOG_MINOR,"RealtimePresence.onAttached()","channel = "+this.channel.name+", hasPresence = "+e),e?this.members.startSync():(this._synthesizeLeaves(this.members.values()),this.members.clear()),this._ensureMyMembersPresent();let n=this.pendingPresence,r=n.length;if(r){this.pendingPresence=[];let i=[],a=Pe.create();o.logAction(o.LOG_MICRO,"RealtimePresence.onAttached","sending "+r+" queued presence messages");for(let c=0;c<r;c++){let l=n[c];i.push(l.presence),a.push(l.callback)}this.channel.sendPresence(i,a)}}actOnChannelState(e,n,r){switch(e){case"attached":this.onAttached(n);break;case"detached":case"failed":this._clearMyMembers(),this.members.clear();case"suspended":this.failPendingPresence(r);break}}failPendingPresence(e){if(this.pendingPresence.length){o.logAction(o.LOG_MINOR,"RealtimeChannel.failPendingPresence","channel; name = "+this.channel.name+", err = "+A(e));for(let n=0;n<this.pendingPresence.length;n++)try{this.pendingPresence[n].callback(e)}catch(r){}this.pendingPresence=[]}}_clearMyMembers(){this._myMembers.clear()}_ensureMyMembersPresent(){let e=this._myMembers,n=r=>{if(r){let i="Presence auto-re-enter failed: "+r.toString(),a=new f(i,91004,400);o.logAction(o.LOG_ERROR,"RealtimePresence._ensureMyMembersPresent()",i);let c=new We(this.channel.state,this.channel.state,!0,!1,a);this.channel.emit("update",c)}};for(let r in e.map){let i=e.map[r];o.logAction(o.LOG_MICRO,"RealtimePresence._ensureMyMembersPresent()",'Auto-reentering clientId "'+i.clientId+'" into the presence set'),B(this._enterOrUpdateClient(i.id,i.clientId,i.data,"enter"),n)}}_synthesizeLeaves(e){let n=this.subscriptions;e.forEach(function(r){let i=j({action:"leave",connectionId:r.connectionId,clientId:r.clientId,data:r.data,encoding:r.encoding,timestamp:Date.now()});n.emit("leave",i)})}async subscribe(...e){let n=ze.processListenerArgs(e),r=n[0],i=n[1],a=this.channel;if(a.state==="failed")throw f.fromValues(a.invalidStateError());this.subscriptions.on(r,i),await a.attach()}unsubscribe(...e){let n=ze.processListenerArgs(e),r=n[0],i=n[1];this.subscriptions.off(r,i)}},kt=class extends v{constructor(e,n){super();this.presence=e,this.map=Object.create(null),this.syncInProgress=!1,this.residualMembers=null,this.memberKey=n}get(e){return this.map[e]}getClient(e){let n=this.map,r=[];for(let i in n){let a=n[i];a.clientId==e&&a.action!="absent"&&r.push(a)}return r}list(e){let n=this.map,r=e&&e.clientId,i=e&&e.connectionId,a=[];for(let c in n){let l=n[c];l.action!=="absent"&&(r&&r!=l.clientId||i&&i!=l.connectionId||a.push(l))}return a}put(e){(e.action==="enter"||e.action==="update")&&(e=j(e),e.action="present");let n=this.map,r=this.memberKey(e);this.residualMembers&&delete this.residualMembers[r];let i=n[r];return i&&!Js(e,i)?!1:(n[r]=e,!0)}values(){let e=this.map,n=[];for(let r in e){let i=e[r];i.action!="absent"&&n.push(i)}return n}remove(e){let n=this.map,r=this.memberKey(e),i=n[r];return i&&!Js(e,i)?!1:(this.syncInProgress?(e=j(e),e.action="absent",n[r]=e):delete n[r],!0)}startSync(){let e=this.map,n=this.syncInProgress;o.logAction(o.LOG_MINOR,"PresenceMap.startSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+n),this.syncInProgress||(this.residualMembers=ee(e),this.setInProgress(!0))}endSync(){let e=this.map,n=this.syncInProgress;if(o.logAction(o.LOG_MINOR,"PresenceMap.endSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+n),n){for(let r in e)e[r].action==="absent"&&delete e[r];this.presence._synthesizeLeaves(_t(this.residualMembers));for(let r in this.residualMembers)delete e[r];this.residualMembers=null,this.setInProgress(!1)}this.emit("sync")}waitSync(e){let n=this.syncInProgress;if(o.logAction(o.LOG_MINOR,"PresenceMap.waitSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+n),!n){e();return}this.once("sync",e)}clear(){this.map={},this.setInProgress(!1),this.residualMembers=null}setInProgress(e){o.logAction(o.LOG_MICRO,"PresenceMap.setInProgress()","inProgress = "+e),this.syncInProgress=e,this.presence.syncComplete=!e}},Qs=Bn;var Ti=N.WebSocket;function Ii(s){return!!s.on}var _n=class extends ae{constructor(e,n,r){super(e,n,r);this.shortName=Ti;r.heartbeats=d.Config.useProtocolHeartbeats,this.wsHost=r.host}static isAvailable(){return!!d.Config.WebSocket}createWebSocket(e,n){return this.uri=e+ie(n),new d.Config.WebSocket(this.uri)}toString(){return"WebSocketTransport; uri="+this.uri}connect(){o.logAction(o.LOG_MINOR,"WebSocketTransport.connect()","starting"),ae.prototype.connect.call(this);let e=this,n=this.params,r=n.options,a=(r.tls?"wss://":"ws://")+this.wsHost+":"+R.getPort(r)+"/";o.logAction(o.LOG_MINOR,"WebSocketTransport.connect()","uri: "+a),B(this.auth.getAuthParams(),function(c,l){if(e.isDisposed)return;let u="";for(let h in l)u+=" "+h+": "+l[h]+";";if(o.logAction(o.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+u+" err: "+c),c){e.disconnect(c);return}let p=n.getConnectParams(l);try{let h=e.wsConnection=e.createWebSocket(a,p);h.binaryType=d.Config.binaryType,h.onopen=function(){e.onWsOpen()},h.onclose=function(g){e.onWsClose(g)},h.onmessage=function(g){e.onWsData(g.data)},h.onerror=function(g){e.onWsError(g)},Ii(h)&&h.on("ping",function(){e.onActivity()})}catch(h){o.logAction(o.LOG_ERROR,"WebSocketTransport.connect()","Unexpected exception creating websocket: err = "+(h.stack||h.message)),e.disconnect(h)}})}send(e){let n=this.wsConnection;if(!n){o.logAction(o.LOG_ERROR,"WebSocketTransport.send()","No socket connection");return}try{n.send(Ns(e,this.connectionManager.realtime._MsgPack,this.params.format))}catch(r){let i="Exception from ws connection when trying to send: "+A(r);o.logAction(o.LOG_ERROR,"WebSocketTransport.send()",i),this.finish("disconnected",new f(i,5e4,500))}}onWsData(e){o.logAction(o.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+e.length+"; type = "+typeof e);try{this.onProtocolMessage(Hs(e,this.connectionManager.realtime._MsgPack,this.connectionManager.realtime._RealtimePresence,this.format))}catch(n){o.logAction(o.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+n.stack)}}onWsOpen(){o.logAction(o.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket"),this.emit("preconnect")}onWsClose(e){let n,r;if(typeof e=="object"?(r=e.code,n=e.wasClean||r===1e3):(r=e,n=r==1e3),delete this.wsConnection,n){o.logAction(o.LOG_MINOR,"WebSocketTransport.onWsClose()","Cleanly closed WebSocket");let i=new f("Websocket closed",80003,400);this.finish("disconnected",i)}else{let i="Unclean disconnection of WebSocket ; code = "+r,a=new f(i,80003,400);o.logAction(o.LOG_MINOR,"WebSocketTransport.onWsClose()",i),this.finish("disconnected",a)}this.emit("disposed")}onWsError(e){o.logAction(o.LOG_MINOR,"WebSocketTransport.onError()","Error from WebSocket: "+e.message),d.Config.nextTick(()=>{this.disconnect(Error(e.message))})}dispose(){o.logAction(o.LOG_MINOR,"WebSocketTransport.dispose()",""),this.isDisposed=!0;let e=this.wsConnection;e&&(e.onmessage=function(){},delete this.wsConnection,d.Config.nextTick(function(){if(o.logAction(o.LOG_MICRO,"WebSocketTransport.dispose()","closing websocket"),!e)throw new Error("WebSocketTransport.dispose(): wsConnection is not defined");e.close()}))}},At=_n;var wt=class{static subscribeFilter(t,e,n){let r=i=>{var c,l,u,p,h,g;let a={name:i.name,refTimeserial:(l=(c=i.extras)==null?void 0:c.ref)==null?void 0:l.timeserial,refType:(p=(u=i.extras)==null?void 0:u.ref)==null?void 0:p.type,isRef:!!((g=(h=i.extras)==null?void 0:h.ref)!=null&&g.timeserial),clientId:i.clientId};Object.entries(e).find(([m,y])=>y!==void 0?a[m]!==y:!1)||n(i)};this.addFilteredSubscription(t,e,n,r),t.subscriptions.on(r)}static addFilteredSubscription(t,e,n,r){var i;if(t.filteredSubscriptions||(t.filteredSubscriptions=new Map),t.filteredSubscriptions.has(n)){let a=t.filteredSubscriptions.get(n);a.set(e,((i=a==null?void 0:a.get(e))==null?void 0:i.concat(r))||[r])}else t.filteredSubscriptions.set(n,new Map([[e,[r]]]))}static getAndDeleteFilteredSubscriptions(t,e,n){if(!t.filteredSubscriptions)return[];if(!n&&e)return Array.from(t.filteredSubscriptions.entries()).map(([a,c])=>{var u;let l=c.get(e);return c.delete(e),c.size===0&&((u=t.filteredSubscriptions)==null||u.delete(a)),l}).reduce((a,c)=>c?a.concat(...c):a,[]);if(!n||!t.filteredSubscriptions.has(n))return[];let r=t.filteredSubscriptions.get(n);if(!e){let a=Array.from(r.values()).reduce((c,l)=>c.concat(...l),[]);return t.filteredSubscriptions.delete(n),a}let i=r.get(e);return r.delete(e),i||[]}};var $=class $ extends Ks{constructor(t){var n;let e=$._MsgPack;if(!e)throw new Error("Expected DefaultRealtime._MsgPack to have been set");super(R.objectifyOptions(t,!0,"Realtime",J(x({},bt),{Crypto:(n=$.Crypto)!=null?n:void 0,MsgPack:e,RealtimePresence:{RealtimePresence:Qs,presenceMessageFromValues:j,presenceMessagesFromValuesArray:gt},WebSocketTransport:At,MessageInteractions:wt})))}static get Crypto(){if(this._Crypto===null)throw new Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto(t){this._Crypto=t}};$.Utils=w,$.ConnectionManager=It,$.ProtocolMessage=Ct,$._Crypto=null,$.Message=Ae,$.PresenceMessage=we,$._MsgPack=null,$._Http=ue;var Se=$;var Hn=Uint8Array,Xe=Uint32Array,Gn=Math.pow,$s=new Xe(8),Ys=[],Ke=new Xe(64);function Xs(s){return(s-(s|0))*Gn(2,32)|0}var Je=2,Qe=0;for(;Qe<64;){for(Ln=!0,Ot=2;Ot<=Je/2;Ot++)Je%Ot===0&&(Ln=!1);Ln&&(Qe<8&&($s[Qe]=Xs(Gn(Je,1/2))),Ys[Qe]=Xs(Gn(Je,1/3)),Qe++),Je++}var Ln,Ot,ki=!!new Hn(new Xe([1]).buffer)[0];function qn(s){return ki?s>>>24|(s>>>16&255)<<8|(s&65280)<<8|s<<24:s}function re(s,t){return s>>>t|s<<32-t}function Nn(s){var t=$s.slice(),e=s.length,n=e*8,r=512-(n+64)%512-1+n+65,i=new Hn(r/8),a=new Xe(i.buffer);i.set(s,0),i[e]=128,a[a.length-1]=qn(n);for(var c,l=0;l<r/32;l+=16){var u=t.slice();for(c=0;c<64;c++){var p;if(c<16)p=qn(a[l+c]);else{var h=Ke[c-15],g=Ke[c-2];p=Ke[c-7]+Ke[c-16]+(re(h,7)^re(h,18)^h>>>3)+(re(g,17)^re(g,19)^g>>>10)}Ke[c]=p|=0;for(var m=(re(u[4],6)^re(u[4],11)^re(u[4],25))+(u[4]&u[5]^~u[4]&u[6])+u[7]+p+Ys[c],y=(re(u[0],2)^re(u[0],13)^re(u[0],22))+(u[0]&u[1]^u[2]&(u[0]^u[1])),b=7;b>0;b--)u[b]=u[b-1];u[0]=m+y|0,u[4]=u[4]+m|0}for(c=0;c<8;c++)t[c]=t[c]+u[c]|0}return new Hn(new Xe(t.map(function(I){return qn(I)})).buffer)}function Zs(s,t){if(s.length>64&&(s=Nn(s)),s.length<64){let c=new Uint8Array(64);c.set(s,0),s=c}for(var e=new Uint8Array(64),n=new Uint8Array(64),r=0;r<64;r++)e[r]=54^s[r],n[r]=92^s[r];var i=new Uint8Array(t.length+64);i.set(e,0),i.set(t,64);var a=new Uint8Array(64+32);return a.set(n,0),a.set(Nn(i),64),Nn(a)}var Dn=class{constructor(){this.base64CharSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";this.hexCharSet="0123456789abcdef"}uint8ViewToBase64(t){let e="",n=this.base64CharSet,r=t.byteLength,i=r%3,a=r-i,c,l,u,p,h;for(let g=0;g<a;g=g+3)h=t[g]<<16|t[g+1]<<8|t[g+2],c=(h&16515072)>>18,l=(h&258048)>>12,u=(h&4032)>>6,p=h&63,e+=n[c]+n[l]+n[u]+n[p];return i==1?(h=t[a],c=(h&252)>>2,l=(h&3)<<4,e+=n[c]+n[l]+"=="):i==2&&(h=t[a]<<8|t[a+1],c=(h&64512)>>10,l=(h&1008)>>4,u=(h&15)<<2,e+=n[c]+n[l]+n[u]+"="),e}base64ToArrayBuffer(t){let e=atob==null?void 0:atob(t),n=e.length,r=new Uint8Array(n);for(let i=0;i<n;i++){let a=e.charCodeAt(i);r[i]=a}return r.buffer}isBuffer(t){return t instanceof ArrayBuffer||ArrayBuffer.isView(t)}toBuffer(t){if(!ArrayBuffer)throw new Error("Can't convert to Buffer: browser does not support the necessary types");if(t instanceof ArrayBuffer)return new Uint8Array(t);if(ArrayBuffer.isView(t))return new Uint8Array(t.buffer);throw new Error("BufferUtils.toBuffer expected an ArrayBuffer or a view onto one")}toArrayBuffer(t){return t instanceof ArrayBuffer?t:this.toBuffer(t).buffer}base64Encode(t){return this.uint8ViewToBase64(this.toBuffer(t))}base64Decode(t){if(ArrayBuffer&&d.Config.atob)return this.base64ToArrayBuffer(t);throw new Error("Expected ArrayBuffer to exist and Platform.Config.atob to be configured")}hexEncode(t){let e=t instanceof ArrayBuffer?t:t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength);return new Uint8Array(e).reduce((r,i)=>r+i.toString(16).padStart(2,"0"),"")}hexDecode(t){if(t.length%2!==0)throw new Error("Can't create a byte array from a hex string of odd length");let e=new Uint8Array(t.length/2);for(let n=0;n<e.length;n++)e[n]=parseInt(t.slice(2*n,2*(n+1)),16);return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}utf8Encode(t){if(d.Config.TextEncoder)return new d.Config.TextEncoder().encode(t).buffer;throw new Error("Expected TextEncoder to be configured")}utf8Decode(t){if(!this.isBuffer(t))throw new Error("Expected input of utf8decode to be an arraybuffer or typed array");if(TextDecoder)return new TextDecoder().decode(t);throw new Error("Expected TextDecoder to be configured")}areBuffersEqual(t,e){if(!t||!e)return!1;let n=this.toArrayBuffer(t),r=this.toArrayBuffer(e);if(n.byteLength!=r.byteLength)return!1;let i=new Uint8Array(n),a=new Uint8Array(r);for(var c=0;c<i.length;c++)if(i[c]!=a[c])return!1;return!0}byteLength(t){return t instanceof ArrayBuffer||ArrayBuffer.isView(t)?t.byteLength:-1}arrayBufferViewToBuffer(t){return t.buffer}hmacSha256(t,e){return Zs(this.toBuffer(e),this.toBuffer(t))}},Fn=new Dn;var er=function(s,t){var e="aes",n=256,r="cbc",i=16;function a(g){if(g.algorithm==="aes"&&g.mode==="cbc"){if(g.keyLength===128||g.keyLength===256)return;throw new Error("Unsupported key length "+g.keyLength+" for aes-cbc encryption. Encryption key must be 128 or 256 bits (16 or 32 ASCII characters)")}}function c(g){return g.replace("_","/").replace("-","+")}function l(g){return g instanceof u}class u{constructor(m,y,b,I){this.algorithm=m,this.keyLength=y,this.mode=b,this.key=I}}class p{static getDefaultParams(m){var y;if(!m.key)throw new Error("Crypto.getDefaultParams: a key is required");typeof m.key=="string"?y=t.toArrayBuffer(t.base64Decode(c(m.key))):m.key instanceof ArrayBuffer?y=m.key:y=t.toArrayBuffer(m.key);var b=m.algorithm||e,I=y.byteLength*8,k=m.mode||r,O=new u(b,I,k,y);if(m.keyLength&&m.keyLength!==O.keyLength)throw new Error("Crypto.getDefaultParams: a keyLength of "+m.keyLength+" was specified, but the key actually has length "+O.keyLength);return a(O),O}static async generateRandomKey(m){try{return s.getRandomArrayBuffer((m||n)/8)}catch(y){throw new f("Failed to generate random key: "+y.message,400,5e4,y)}}static getCipher(m){var b;var y=l(m)?m:this.getDefaultParams(m);return{cipherParams:y,cipher:new h(y,(b=m.iv)!=null?b:null)}}}p.CipherParams=u;class h{constructor(m,y){if(!crypto.subtle)throw isSecureContext?new Error("Crypto operations are not possible since the browser\u2019s SubtleCrypto class is unavailable (reason unknown)."):new Error("Crypto operations are is not possible since the current environment is a non-secure context and hence the browser\u2019s SubtleCrypto class is not available.");this.algorithm=m.algorithm+"-"+String(m.keyLength)+"-"+m.mode,this.webCryptoAlgorithm=m.algorithm+"-"+m.mode,this.key=t.toArrayBuffer(m.key),this.iv=y?t.toArrayBuffer(y):null}concat(m,y){let b=new ArrayBuffer(m.byteLength+y.byteLength),I=new DataView(b),k=new DataView(t.toArrayBuffer(m));for(let L=0;L<k.byteLength;L++)I.setInt8(L,k.getInt8(L));let O=new DataView(t.toArrayBuffer(y));for(let L=0;L<O.byteLength;L++)I.setInt8(k.byteLength+L,O.getInt8(L));return b}async encrypt(m){o.logAction(o.LOG_MICRO,"CBCCipher.encrypt()","");let y=await this.getIv(),b=await crypto.subtle.importKey("raw",this.key,this.webCryptoAlgorithm,!1,["encrypt"]),I=await crypto.subtle.encrypt({name:this.webCryptoAlgorithm,iv:y},b,m);return this.concat(y,I)}async decrypt(m){o.logAction(o.LOG_MICRO,"CBCCipher.decrypt()","");let y=t.toArrayBuffer(m),b=y.slice(0,i),I=y.slice(i),k=await crypto.subtle.importKey("raw",this.key,this.webCryptoAlgorithm,!1,["decrypt"]);return crypto.subtle.decrypt({name:this.webCryptoAlgorithm,iv:b},k,I)}async getIv(){if(this.iv){var m=this.iv;return this.iv=null,m}let y=await s.getRandomArrayBuffer(i);return t.toArrayBuffer(y)}}return p};var tr=(r=>(r[r.REQ_SEND=0]="REQ_SEND",r[r.REQ_RECV=1]="REQ_RECV",r[r.REQ_RECV_POLL=2]="REQ_RECV_POLL",r[r.REQ_RECV_STREAM=3]="REQ_RECV_STREAM",r))(tr||{}),Y=tr;function nr(){return new f("No HTTP request plugin provided. Provide at least one of the FetchRequest or XHRRequest plugins.",400,4e4)}var $e,sr=($e=class{constructor(s){this.checksInProgress=null;this.checkConnectivity=void 0;this.supportsAuthHeaders=!1;this.supportsLinkHeaders=!1;var l;this.client=s!=null?s:null;let t=(s==null?void 0:s.options.connectivityCheckUrl)||R.connectivityCheckUrl,e=(l=s==null?void 0:s.options.connectivityCheckParams)!=null?l:null,n=!(s!=null&&s.options.connectivityCheckUrl),r=x(x({},sr.bundledRequestImplementations),s==null?void 0:s._additionalHTTPRequestImplementations),i=r.XHRRequest,a=r.FetchRequest,c=!!(i||a);if(!c)throw nr();d.Config.xhrSupported&&i?(this.supportsAuthHeaders=!0,this.Request=async function(u,p,h,g,m){return new Promise(y=>{var I;let b=i.createRequest(p,h,g,m,Y.REQ_SEND,(I=s&&s.options.timeouts)!=null?I:null,u);b.once("complete",(k,O,L,xe,C)=>y({error:k,body:O,headers:L,unpacked:xe,statusCode:C})),b.exec()})},s!=null&&s.options.disableConnectivityCheck?this.checkConnectivity=async function(){return!0}:this.checkConnectivity=async function(){var h;o.logAction(o.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Sending; "+t);let u=await this.doUri(E.Get,t,null,null,e),p=!1;return n?p=!u.error&&((h=u.body)==null?void 0:h.replace(/\n/,""))=="yes":p=!u.error&&Cs(u.statusCode),o.logAction(o.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Result: "+p),p}):d.Config.fetchSupported&&a?(this.supportsAuthHeaders=!0,this.Request=async(u,p,h,g,m)=>a(u,s!=null?s:null,p,h,g,m),this.checkConnectivity=async function(){var h;o.logAction(o.LOG_MICRO,"(Fetch)Http.checkConnectivity()","Sending; "+t);let u=await this.doUri(E.Get,t,null,null,null),p=!u.error&&((h=u.body)==null?void 0:h.replace(/\n/,""))=="yes";return o.logAction(o.LOG_MICRO,"(Fetch)Http.checkConnectivity()","Result: "+p),p}):this.Request=async()=>({error:c?new S("no supported HTTP transports available",null,400):nr()})}async doUri(s,t,e,n,r){return this.Request?this.Request(s,t,e,r,n):{error:new S("Request invoked before assigned to",null,500)}}shouldFallback(s){let t=s.statusCode;return t===408&&!s.code||t===400&&!s.code||t>=500&&t<=504}},$e.methods=[E.Get,E.Delete,E.Post,E.Put,E.Patch],$e.methodsWithoutBody=[E.Get,E.Delete],$e.methodsWithBody=[E.Post,E.Put,E.Patch],$e),jn=sr;var _=Ne();typeof Window=="undefined"&&typeof WorkerGlobalScope=="undefined"&&console.log("Warning: this distribution of Ably is intended for browsers. On nodejs, please use the 'ably' package on npm");function Ai(){let s=_.location;return!_.WebSocket||!s||!s.origin||s.origin.indexOf("http")>-1}function wi(){return typeof WorkerGlobalScope!="undefined"&&self instanceof WorkerGlobalScope}var Oi=_.navigator&&_.navigator.userAgent.toString(),Mi=_.location&&_.location.href,Si={agent:"browser",logTimestamps:!0,userAgent:Oi,currentUrl:Mi,binaryType:"arraybuffer",WebSocket:_.WebSocket,fetchSupported:!!_.fetch,xhrSupported:_.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest,allowComet:Ai(),useProtocolHeartbeats:!0,supportsBinary:!!_.TextDecoder,preferBinary:!1,ArrayBuffer:_.ArrayBuffer,atob:_.atob,nextTick:typeof _.setImmediate!="undefined"?_.setImmediate.bind(_):function(s){setTimeout(s,0)},addEventListener:_.addEventListener,inspect:JSON.stringify,stringByteSize:function(s){return _.TextDecoder&&new _.TextEncoder().encode(s).length||s.length},TextEncoder:_.TextEncoder,TextDecoder:_.TextDecoder,getRandomArrayBuffer:async function(s){let t=new Uint8Array(s);return _.crypto.getRandomValues(t),t.buffer},isWebworker:wi()},Vn=Si;function Ei(s){let t=[80015,80017,80030];return s.code?W.isTokenErr(s)?!1:t.includes(s.code)?!0:s.code>=4e4&&s.code<5e4:!1}function Wn(s){return Ei(s)?[V({action:T.ERROR,error:s})]:[V({action:T.DISCONNECTED,error:s})]}var zn=class extends ae{constructor(e,n,r){super(e,n,r,!0);this.onAuthUpdated=e=>{this.authParams={access_token:e.token}};this.stream="stream"in r?r.stream:!0,this.sendRequest=null,this.recvRequest=null,this.pendingCallback=null,this.pendingItems=null}connect(){o.logAction(o.LOG_MINOR,"CometTransport.connect()","starting"),ae.prototype.connect.call(this);let e=this.params,n=e.options,r=R.getHost(n,e.host),i=R.getPort(n),a=n.tls?"https://":"http://";this.baseUri=a+r+":"+i+"/comet/";let c=this.baseUri+"connect";o.logAction(o.LOG_MINOR,"CometTransport.connect()","uri: "+c),B(this.auth.getAuthParams(),(l,u)=>{if(l){this.disconnect(l);return}if(this.isDisposed)return;this.authParams=u;let p=this.params.getConnectParams(u);"stream"in p&&(this.stream=p.stream),o.logAction(o.LOG_MINOR,"CometTransport.connect()","connectParams:"+ie(p));let h=!1,g=this.recvRequest=this.createRequest(c,null,p,null,this.stream?Y.REQ_RECV_STREAM:Y.REQ_RECV);g.on("data",m=>{this.recvRequest&&(h||(h=!0,this.emit("preconnect")),this.onData(m))}),g.on("complete",m=>{if(this.recvRequest||(m=m||new f("Request cancelled",80003,400)),this.recvRequest=null,!h&&!m&&(h=!0,this.emit("preconnect")),this.onActivity(),m){m.code?this.onData(Wn(m)):this.disconnect(m);return}d.Config.nextTick(()=>{this.recv()})}),g.exec()})}requestClose(){o.logAction(o.LOG_MINOR,"CometTransport.requestClose()"),this._requestCloseOrDisconnect(!0)}requestDisconnect(){o.logAction(o.LOG_MINOR,"CometTransport.requestDisconnect()"),this._requestCloseOrDisconnect(!1)}_requestCloseOrDisconnect(e){let n=e?this.closeUri:this.disconnectUri;if(n){let r=this.createRequest(n,null,this.authParams,null,Y.REQ_SEND);r.on("complete",i=>{i&&(o.logAction(o.LOG_ERROR,"CometTransport.request"+(e?"Close()":"Disconnect()"),"request returned err = "+A(i)),this.finish("disconnected",i))}),r.exec()}}dispose(){o.logAction(o.LOG_MINOR,"CometTransport.dispose()",""),this.isDisposed||(this.isDisposed=!0,this.recvRequest&&(o.logAction(o.LOG_MINOR,"CometTransport.dispose()","aborting recv request"),this.recvRequest.abort(),this.recvRequest=null),this.finish("disconnected",X.disconnected()),d.Config.nextTick(()=>{this.emit("disposed")}))}onConnect(e){var i;if(this.isDisposed)return;let n=(i=e.connectionDetails)==null?void 0:i.connectionKey;ae.prototype.onConnect.call(this,e);let r=this.baseUri+n;o.logAction(o.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+r),this.sendUri=r+"/send",this.recvUri=r+"/recv",this.closeUri=r+"/close",this.disconnectUri=r+"/disconnect"}send(e){if(this.sendRequest){this.pendingItems=this.pendingItems||[],this.pendingItems.push(e);return}let n=this.pendingItems||[];n.push(e),this.pendingItems=null,this.sendItems(n)}sendAnyPending(){let e=this.pendingItems;e&&(this.pendingItems=null,this.sendItems(e))}sendItems(e){let n=this.sendRequest=this.createRequest(this.sendUri,null,this.authParams,this.encodeRequest(e),Y.REQ_SEND);n.on("complete",(r,i)=>{if(r&&o.logAction(o.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+A(r)),this.sendRequest=null,r){r.code?this.onData(Wn(r)):this.disconnect(r);return}i&&this.onData(i),this.pendingItems&&d.Config.nextTick(()=>{this.sendRequest||this.sendAnyPending()})}),n.exec()}recv(){if(this.recvRequest||!this.isConnected)return;let e=this.recvRequest=this.createRequest(this.recvUri,null,this.authParams,null,this.stream?Y.REQ_RECV_STREAM:Y.REQ_RECV_POLL);e.on("data",n=>{this.onData(n)}),e.on("complete",n=>{if(this.recvRequest=null,this.onActivity(),n){n.code?this.onData(Wn(n)):this.disconnect(n);return}d.Config.nextTick(()=>{this.recv()})}),e.exec()}onData(e){try{let n=this.decodeResponse(e);if(n&&n.length)for(let r=0;r<n.length;r++)this.onProtocolMessage(Pt(n[r],this.connectionManager.realtime._RealtimePresence))}catch(n){o.logAction(o.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+n.stack)}}encodeRequest(e){return JSON.stringify(e)}decodeResponse(e){return typeof e=="string"?JSON.parse(e):e}},rr=zn;function vi(s,t){return Le(ce(t)).includes("x-ably-errorcode")}function xi(s,t){if(vi(s,t))return s.error&&f.fromValues(s.error)}var Ui=function(){},Bi=0,ir={};function _i(s,t){return s.getResponseHeader&&s.getResponseHeader(t)}function Li(s){return s.getResponseHeader&&(s.getResponseHeader("transfer-encoding")||!s.getResponseHeader("content-length"))}function qi(s){let t=s.getAllResponseHeaders().trim().split(`\r
`),e={};for(let n=0;n<t.length;n++){let r=t[n].split(":").map(i=>i.trim());e[r[0].toLowerCase()]=r[1]}return e}var Kn=class s extends v{constructor(e,n,r,i,a,c,l){super();r=r||{},r.rnd=_e(),this.uri=e+ie(r),this.headers=n||{},this.body=i,this.method=l?l.toUpperCase():Q(i)?"GET":"POST",this.requestMode=a,this.timeouts=c,this.timedOut=!1,this.requestComplete=!1,this.id=String(++Bi),ir[this.id]=this}static createRequest(e,n,r,i,a,c,l){let u=c||R.TIMEOUTS;return new s(e,n,ee(r),i,a,u,l)}complete(e,n,r,i,a){this.requestComplete||(this.requestComplete=!0,!e&&n&&this.emit("data",n),this.emit("complete",e,n,r,i,a),this.dispose())}abort(){this.dispose()}exec(){let e=this.headers,n=this.requestMode==Y.REQ_SEND?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout,r=this.timer=setTimeout(()=>{this.timedOut=!0,a.abort()},n),i=this.method,a=this.xhr=new XMLHttpRequest,c=e.accept,l=this.body,u="text";c?c.indexOf("application/x-msgpack")===0&&(u="arraybuffer"):e.accept="application/json",l&&(e["content-type"]||(e["content-type"]="application/json")).indexOf("application/json")>-1&&typeof l!="string"&&(l=JSON.stringify(l)),a.open(i,this.uri,!0),a.responseType=u,"authorization"in e&&(a.withCredentials=!0);for(let C in e)a.setRequestHeader(C,e[C]);let p=(C,K,H,Ue)=>{var es;let fe=K+" (event type: "+C.type+")";(es=this==null?void 0:this.xhr)!=null&&es.statusText&&(fe+=", current statusText is "+this.xhr.statusText),o.logAction(o.LOG_ERROR,"Request.on"+C.type+"()",fe),this.complete(new S(fe,H,Ue))};a.onerror=function(C){p(C,"XHR error occurred",null,400)},a.onabort=C=>{this.timedOut?p(C,"Request aborted due to request timeout expiring",null,408):p(C,"Request cancelled",null,400)},a.ontimeout=function(C){p(C,"Request timed out",null,408)};let h,g,m,y=0,b=!1,I=()=>{if(clearTimeout(r),m=g<400,g==204){this.complete(null,null,null,null,g);return}h=this.requestMode==Y.REQ_RECV_STREAM&&m&&Li(a)},k=()=>{let C;try{let H=_i(a,"content-type");if(H?H.indexOf("application/json")>=0:a.responseType=="text"){let fe=a.responseType==="arraybuffer"?d.BufferUtils.utf8Decode(a.response):String(a.responseText);fe.length?C=JSON.parse(fe):C=fe,b=!0}else C=a.response;C.response!==void 0?(g=C.statusCode,m=g<400,e=C.headers,C=C.response):e=qi(a)}catch(H){this.complete(new S("Malformed response body from server: "+H.message,null,400));return}if(m||Array.isArray(C)){this.complete(null,C,e,b,g);return}let K=xi(C,e);K||(K=new S("Error response received from server: "+g+" body was: "+d.Config.inspect(C),null,g)),this.complete(K,C,e,b,g)};function O(){let C=a.responseText,K=C.length-1,H,Ue;for(;y<K&&(H=C.indexOf(`
`,y))>-1;)Ue=C.slice(y,H),y=H+1,L(Ue)}let L=C=>{try{C=JSON.parse(C)}catch(K){this.complete(new S("Malformed response body from server: "+K.message,null,400));return}this.emit("data",C)},xe=()=>{O(),this.streamComplete=!0,d.Config.nextTick(()=>{this.complete()})};a.onreadystatechange=function(){let C=a.readyState;C<3||a.status!==0&&(g===void 0&&(g=a.status,I()),C==3&&h?O():C==4&&(h?xe():k()))},a.send(l)}dispose(){let e=this.xhr;if(e){e.onreadystatechange=e.onerror=e.onabort=e.ontimeout=Ui,this.xhr=null;let n=this.timer;n&&(clearTimeout(n),this.timer=null),this.requestComplete||e.abort()}delete ir[this.id]}},Mt=Kn;var or=N.XhrPolling,Jn=class extends rr{constructor(e,n,r){super(e,n,r);this.shortName=or;r.stream=!1,this.shortName=or}static isAvailable(){return!!(d.Config.xhrSupported&&d.Config.allowComet)}toString(){return"XHRPollingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected}createRequest(e,n,r,i,a){return Mt.createRequest(e,n,r,i,a,this.timeouts)}},ar=Jn;var Ni=["xhr_polling"],Hi={order:Ni,bundledImplementations:{web_socket:At,xhr_polling:ar}},cr=Hi;var Ee="ablyjs-storage-test",ve=typeof global!="undefined"?global:typeof window!="undefined"?window:self,Qn=class{constructor(){try{ve.sessionStorage.setItem(Ee,Ee),ve.sessionStorage.removeItem(Ee),this.sessionSupported=!0}catch(t){this.sessionSupported=!1}try{ve.localStorage.setItem(Ee,Ee),ve.localStorage.removeItem(Ee),this.localSupported=!0}catch(t){this.localSupported=!1}}get(t){return this._get(t,!1)}getSession(t){return this._get(t,!0)}remove(t){return this._remove(t,!1)}removeSession(t){return this._remove(t,!0)}set(t,e,n){return this._set(t,e,n,!1)}setSession(t,e,n){return this._set(t,e,n,!0)}_set(t,e,n,r){let i={value:e};return n&&(i.expires=Date.now()+n),this.storageInterface(r).setItem(t,JSON.stringify(i))}_get(t,e){if(e&&!this.sessionSupported)throw new Error("Session Storage not supported");if(!e&&!this.localSupported)throw new Error("Local Storage not supported");let n=this.storageInterface(e).getItem(t);if(!n)return null;let r=JSON.parse(n);return r.expires&&r.expires<Date.now()?(this.storageInterface(e).removeItem(t),null):r.value}_remove(t,e){return this.storageInterface(e).removeItem(t)}storageInterface(t){return t?ve.sessionStorage:ve.localStorage}},lr=new Qn;var Gi={connectivityCheckUrl:"https://internet-up.ably-realtime.com/is-the-internet-up.txt",wsConnectivityUrl:"wss://ws-up.ably-realtime.com",defaultTransports:[N.XhrPolling,N.WebSocket]},ur=Gi;function Di(s){if(s===void 0)return"undefined";let t,e;if(s instanceof ArrayBuffer?(e="ArrayBuffer",t=new DataView(s)):s instanceof DataView&&(e="DataView",t=s),!t)return JSON.stringify(s);let n=[];for(let r=0;r<s.byteLength;r++){if(r>20){n.push("...");break}let i=t.getUint8(r).toString(16);i.length===1&&(i="0"+i),n.push(i)}return"<"+e+" "+n.join(" ")+">"}function Ye(s,t,e){for(let n=0,r=e.length;n<r;n++){let i=e.charCodeAt(n);if(i<128){s.setUint8(t++,i>>>0&127|0);continue}if(i<2048){s.setUint8(t++,i>>>6&31|192),s.setUint8(t++,i>>>0&63|128);continue}if(i<65536){s.setUint8(t++,i>>>12&15|224),s.setUint8(t++,i>>>6&63|128),s.setUint8(t++,i>>>0&63|128);continue}if(i<1114112){s.setUint8(t++,i>>>18&7|240),s.setUint8(t++,i>>>12&63|128),s.setUint8(t++,i>>>6&63|128),s.setUint8(t++,i>>>0&63|128);continue}throw new Error("bad codepoint "+i)}}function hr(s,t,e){let n="";for(let r=t,i=t+e;r<i;r++){let a=s.getUint8(r);if(!(a&128)){n+=String.fromCharCode(a);continue}if((a&224)===192){n+=String.fromCharCode((a&15)<<6|s.getUint8(++r)&63);continue}if((a&240)===224){n+=String.fromCharCode((a&15)<<12|(s.getUint8(++r)&63)<<6|(s.getUint8(++r)&63)<<0);continue}if((a&248)===240){n+=String.fromCharCode((a&7)<<18|(s.getUint8(++r)&63)<<12|(s.getUint8(++r)&63)<<6|(s.getUint8(++r)&63)<<0);continue}throw new Error("Invalid byte "+a.toString(16))}return n}function $n(s){let t=0;for(let e=0,n=s.length;e<n;e++){let r=s.charCodeAt(e);if(r<128){t+=1;continue}if(r<2048){t+=2;continue}if(r<65536){t+=3;continue}if(r<1114112){t+=4;continue}throw new Error("bad codepoint "+r)}return t}function Fi(s,t){let e=et(s,t);if(e===0)return;let n=new ArrayBuffer(e),r=new DataView(n);return Ze(s,r,0,t),n}var Yn=65536*65536,dr=1/Yn;function ji(s,t){return t=t||0,s.getInt32(t)*Yn+s.getUint32(t+4)}function Vi(s,t){return t=t||0,s.getUint32(t)*Yn+s.getUint32(t+4)}function Wi(s,t,e){e<9223372036854776e3?(s.setInt32(t,Math.floor(e*dr)),s.setInt32(t+4,e&-1)):(s.setUint32(t,2147483647),s.setUint32(t+4,2147483647))}function zi(s,t,e){e<18446744073709552e3?(s.setUint32(t,Math.floor(e*dr)),s.setInt32(t+4,e&-1)):(s.setUint32(t,4294967295),s.setUint32(t+4,4294967295))}var Xn=class{constructor(t,e){this.map=t=>{let e={};for(let n=0;n<t;n++){let r=this.parse();e[r]=this.parse()}return e};this.bin=t=>{let e=new ArrayBuffer(t);return new Uint8Array(e).set(new Uint8Array(this.view.buffer,this.offset,t),0),this.offset+=t,e};this.buf=this.bin;this.str=t=>{let e=hr(this.view,this.offset,t);return this.offset+=t,e};this.array=t=>{let e=new Array(t);for(let n=0;n<t;n++)e[n]=this.parse();return e};this.ext=t=>(this.offset+=t,{type:this.view.getInt8(this.offset),data:this.buf(t)});this.parse=()=>{let t=this.view.getUint8(this.offset),e,n;if(!(t&128))return this.offset++,t;if((t&240)===128)return n=t&15,this.offset++,this.map(n);if((t&240)===144)return n=t&15,this.offset++,this.array(n);if((t&224)===160)return n=t&31,this.offset++,this.str(n);if((t&224)===224)return e=this.view.getInt8(this.offset),this.offset++,e;switch(t){case 192:return this.offset++,null;case 193:this.offset++;return;case 194:return this.offset++,!1;case 195:return this.offset++,!0;case 196:return n=this.view.getUint8(this.offset+1),this.offset+=2,this.bin(n);case 197:return n=this.view.getUint16(this.offset+1),this.offset+=3,this.bin(n);case 198:return n=this.view.getUint32(this.offset+1),this.offset+=5,this.bin(n);case 199:return n=this.view.getUint8(this.offset+1),this.offset+=2,this.ext(n);case 200:return n=this.view.getUint16(this.offset+1),this.offset+=3,this.ext(n);case 201:return n=this.view.getUint32(this.offset+1),this.offset+=5,this.ext(n);case 202:return e=this.view.getFloat32(this.offset+1),this.offset+=5,e;case 203:return e=this.view.getFloat64(this.offset+1),this.offset+=9,e;case 204:return e=this.view.getUint8(this.offset+1),this.offset+=2,e;case 205:return e=this.view.getUint16(this.offset+1),this.offset+=3,e;case 206:return e=this.view.getUint32(this.offset+1),this.offset+=5,e;case 207:return e=Vi(this.view,this.offset+1),this.offset+=9,e;case 208:return e=this.view.getInt8(this.offset+1),this.offset+=2,e;case 209:return e=this.view.getInt16(this.offset+1),this.offset+=3,e;case 210:return e=this.view.getInt32(this.offset+1),this.offset+=5,e;case 211:return e=ji(this.view,this.offset+1),this.offset+=9,e;case 212:return n=1,this.offset++,this.ext(n);case 213:return n=2,this.offset++,this.ext(n);case 214:return n=4,this.offset++,this.ext(n);case 215:return n=8,this.offset++,this.ext(n);case 216:return n=16,this.offset++,this.ext(n);case 217:return n=this.view.getUint8(this.offset+1),this.offset+=2,this.str(n);case 218:return n=this.view.getUint16(this.offset+1),this.offset+=3,this.str(n);case 219:return n=this.view.getUint32(this.offset+1),this.offset+=5,this.str(n);case 220:return n=this.view.getUint16(this.offset+1),this.offset+=3,this.array(n);case 221:return n=this.view.getUint32(this.offset+1),this.offset+=5,this.array(n);case 222:return n=this.view.getUint16(this.offset+1),this.offset+=3,this.map(n);case 223:return n=this.view.getUint32(this.offset+1),this.offset+=5,this.map(n)}throw new Error("Unknown type 0x"+t.toString(16))};this.offset=e||0,this.view=t}};function Ki(s){let t=new DataView(s),e=new Xn(t),n=e.parse();if(e.offset!==s.byteLength)throw new Error(s.byteLength-e.offset+" trailing bytes");return n}function fr(s,t){return Object.keys(s).filter(function(e){let n=s[e],r=typeof n;return(!t||n!=null)&&(r!=="function"||!!n.toJSON)})}function Ze(s,t,e,n){let r=typeof s;if(typeof s=="string"){let i=$n(s);if(i<32)return t.setUint8(e,i|160),Ye(t,e+1,s),1+i;if(i<256)return t.setUint8(e,217),t.setUint8(e+1,i),Ye(t,e+2,s),2+i;if(i<65536)return t.setUint8(e,218),t.setUint16(e+1,i),Ye(t,e+3,s),3+i;if(i<4294967296)return t.setUint8(e,219),t.setUint32(e+1,i),Ye(t,e+5,s),5+i}if(ArrayBuffer.isView&&ArrayBuffer.isView(s)&&(s=s.buffer),s instanceof ArrayBuffer){let i=s.byteLength;if(i<256)return t.setUint8(e,196),t.setUint8(e+1,i),new Uint8Array(t.buffer).set(new Uint8Array(s),e+2),2+i;if(i<65536)return t.setUint8(e,197),t.setUint16(e+1,i),new Uint8Array(t.buffer).set(new Uint8Array(s),e+3),3+i;if(i<4294967296)return t.setUint8(e,198),t.setUint32(e+1,i),new Uint8Array(t.buffer).set(new Uint8Array(s),e+5),5+i}if(typeof s=="number"){if(Math.floor(s)!==s)return t.setUint8(e,203),t.setFloat64(e+1,s),9;if(s>=0){if(s<128)return t.setUint8(e,s),1;if(s<256)return t.setUint8(e,204),t.setUint8(e+1,s),2;if(s<65536)return t.setUint8(e,205),t.setUint16(e+1,s),3;if(s<4294967296)return t.setUint8(e,206),t.setUint32(e+1,s),5;if(s<18446744073709552e3)return t.setUint8(e,207),zi(t,e+1,s),9;throw new Error("Number too big 0x"+s.toString(16))}if(s>=-32)return t.setInt8(e,s),1;if(s>=-128)return t.setUint8(e,208),t.setInt8(e+1,s),2;if(s>=-32768)return t.setUint8(e,209),t.setInt16(e+1,s),3;if(s>=-2147483648)return t.setUint8(e,210),t.setInt32(e+1,s),5;if(s>=-9223372036854776e3)return t.setUint8(e,211),Wi(t,e+1,s),9;throw new Error("Number too small -0x"+(-s).toString(16).substr(1))}if(r==="undefined")return n?0:(t.setUint8(e,212),t.setUint8(e+1,0),t.setUint8(e+2,0),3);if(s===null)return n?0:(t.setUint8(e,192),1);if(r==="boolean")return t.setUint8(e,s?195:194),1;if(typeof s.toJSON=="function")return Ze(s.toJSON(),t,e,n);if(r==="object"){let i,a=0,c,l=Array.isArray(s);if(l?i=s.length:(c=fr(s,n),i=c.length),i<16?(t.setUint8(e,i|(l?144:128)),a=1):i<65536?(t.setUint8(e,l?220:222),t.setUint16(e+1,i),a=3):i<4294967296&&(t.setUint8(e,l?221:223),t.setUint32(e+1,i),a=5),l)for(let u=0;u<i;u++)a+=Ze(s[u],t,e+a,n);else if(c)for(let u=0;u<i;u++){let p=c[u];a+=Ze(p,t,e+a),a+=Ze(s[p],t,e+a,n)}return a}if(r==="function")return 0;throw new Error("Unknown type "+r)}function et(s,t){let e=typeof s;if(e==="string"){let n=$n(s);if(n<32)return 1+n;if(n<256)return 2+n;if(n<65536)return 3+n;if(n<4294967296)return 5+n}if(ArrayBuffer.isView&&ArrayBuffer.isView(s)&&(s=s.buffer),s instanceof ArrayBuffer){let n=s.byteLength;if(n<256)return 2+n;if(n<65536)return 3+n;if(n<4294967296)return 5+n}if(typeof s=="number"){if(Math.floor(s)!==s)return 9;if(s>=0){if(s<128)return 1;if(s<256)return 2;if(s<65536)return 3;if(s<4294967296)return 5;if(s<18446744073709552e3)return 9;throw new Error("Number too big 0x"+s.toString(16))}if(s>=-32)return 1;if(s>=-128)return 2;if(s>=-32768)return 3;if(s>=-2147483648)return 5;if(s>=-9223372036854776e3)return 9;throw new Error("Number too small -0x"+s.toString(16).substr(1))}if(e==="boolean")return 1;if(s===null)return t?0:1;if(s===void 0)return t?0:3;if(typeof s.toJSON=="function")return et(s.toJSON(),t);if(e==="object"){let n,r=0;if(Array.isArray(s)){n=s.length;for(let i=0;i<n;i++)r+=et(s[i],t)}else{let i=fr(s,t);n=i.length;for(let a=0;a<n;a++){let c=i[a];r+=et(c)+et(s[c],t)}}if(n<16)return 1+r;if(n<65536)return 3+r;if(n<4294967296)return 5+r;throw new Error("Array or object too long 0x"+n.toString(16))}if(e==="function")return 0;throw new Error("Unknown type "+e)}var St={encode:Fi,decode:Ki,inspect:Di,utf8Write:Ye,utf8Read:hr,utf8ByteCount:$n};function Ji(s,t){return!!t.get("x-ably-errorcode")}function Qi(s,t){if(Ji(s,t))return s.error&&f.fromValues(s.error)}function Xi(s){let t={};return s.forEach((e,n)=>{t[n]=e}),t}async function Zn(s,t,e,n,r,i){let a=new Headers(n||{}),c=s?s.toUpperCase():Q(i)?"GET":"POST",l=new AbortController,u,p=new Promise(m=>{u=setTimeout(()=>{l.abort(),m({error:new S("Request timed out",null,408)})},t?t.options.timeouts.httpRequestTimeout:R.TIMEOUTS.httpRequestTimeout)}),h={method:c,headers:a,body:i};d.Config.isWebworker||(h.credentials=a.has("authorization")?"include":"same-origin");let g=(async()=>{try{let m=await Ne().fetch(e+"?"+new URLSearchParams(r||{}),h);clearTimeout(u);let y=m.headers.get("Content-Type"),b;y&&y.indexOf("application/x-msgpack")>-1?b=await m.arrayBuffer():y&&y.indexOf("application/json")>-1?b=await m.json():b=await m.text();let I=!!y&&y.indexOf("application/x-msgpack")===-1,k=Xi(m.headers);return m.ok?{error:null,body:b,headers:k,unpacked:I,statusCode:m.status}:{error:Qi(b,m.headers)||new S("Error response received from server: "+m.status+" body was: "+d.Config.inspect(b),null,m.status),body:b,headers:k,unpacked:I,statusCode:m.status}}catch(m){return clearTimeout(u),{error:m}}})();return Promise.race([p,g])}var pr={XHRRequest:Mt,FetchRequest:Zn};var mr=er(Vn,Fn);d.Crypto=mr;d.BufferUtils=Fn;d.Http=jn;d.Config=Vn;d.Transports=cr;d.WebStorage=lr;for(let s of[Oe,Se])s.Crypto=mr,s._MsgPack=St;jn.bundledRequestImplementations=pr;o.initLogHandlers();d.Defaults=Rs(ur);d.Config.agent&&(d.Defaults.agent+=" "+d.Config.agent);var $i={ErrorInfo:f,Rest:Oe,Realtime:Se,msgpack:St};
if (typeof module.exports == "object" && typeof exports == "object") {
  var __cp = (to, from, except, desc) => {
    if ((from && typeof from === "object") || typeof from === "function") {
      for (let key of Object.getOwnPropertyNames(from)) {
        if (!Object.prototype.hasOwnProperty.call(to, key) && key !== except)
        Object.defineProperty(to, key, {
          get: () => from[key],
          enumerable: !(desc = Object.getOwnPropertyDescriptor(from, key)) || desc.enumerable,
        });
      }
    }
    return to;
  };
  module.exports = __cp(module.exports, exports);
}
return module.exports;
}))
//# sourceMappingURL=ably.min.js.map
